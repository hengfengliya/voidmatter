/**
 * æœ‰ç‰©AI - ç²¾ç®€ç‰ˆDeepSeekè”ç½‘èŠå¤©ç³»ç»Ÿ
 * é‡‡ç”¨å¤¸å…‹AIé£æ ¼çš„ç®€æ´ç•Œé¢è®¾è®¡
 * é›†æˆç«å±±å¼•æ“DeepSeek API + è”ç½‘æœç´¢åŠŸèƒ½
 */

class YouwoAI {
    constructor() {
        // ä»é…ç½®æ–‡ä»¶åŠ è½½APIé…ç½®
        this.config = window.YouwoAIConfig ?
            window.YouwoAIConfig.get() :
            {
                apiKey: '4dea1399-3986-471a-8f8c-b080f01fa103',
                baseURL: 'https://ark.cn-beijing.volces.com/api/v3',
                model: 'bot-20250915112813-kx2qr',
                maxTokens: 4096,
                temperature: 0.7,
                topP: 0.9
            };

        // å½“å‰AIæ¨¡å¼ - é»˜è®¤ä¸ºå…¨éƒ¨
        this.currentMode = 'all';

        // å¯¹è¯å†å²
        this.messages = [];

        // æ˜¯å¦æ­£åœ¨å‘é€è¯·æ±‚
        this.isLoading = false;

        // æ˜¯å¦å·²å¼€å§‹å¯¹è¯
        this.hasStartedChat = false;

        // å½“å‰åŠ¨æ€é—®é¢˜ï¼ˆåŸºäºä¸Šæ¬¡AIå›å¤ç”Ÿæˆï¼‰
        this.dynamicQuestions = [];

        // æ˜¯å¦æ­£åœ¨ç”Ÿæˆåç»­é—®é¢˜
        this.isGeneratingQuestions = false;
        
        // æ¨¡å¼å®šä¹‰
        this.modes = {
            industry: {
                name: 'è¡Œä¸šåˆ†æ',
                icon: 'fas fa-industry',
                placeholder: 'è¾“å…¥è¡Œä¸šåç§°æˆ–å…³é”®è¯ï¼Œå¦‚"æ–°èƒ½æºæ±½è½¦"ã€"åŠå¯¼ä½“"ã€"æ¶ˆè´¹ç”µå­"...',
                suggestedQuestions: [
                    'æ–°èƒ½æºæ±½è½¦è¡Œä¸šè¿˜èƒ½æŠ•èµ„å—ï¼Ÿ',
                    'äººå·¥æ™ºèƒ½å“ªä¸ªç»†åˆ†èµ›é“æœ€æœ‰æ½œåŠ›ï¼Ÿ',
                    'åŒ»è¯è¡Œä¸šæ”¿ç­–é£é™©å¤§å—ï¼Ÿ',
                    'æ¶ˆè´¹è¡Œä¸šç°åœ¨æ˜¯å¦è§¦åº•ï¼Ÿ',
                    'åŠå¯¼ä½“è¡Œä¸šå‘¨æœŸæ‹ç‚¹åˆ°äº†å—ï¼Ÿ',
                    'æˆ¿åœ°äº§è¡Œä¸šè¿˜æœ‰æŠ•èµ„ä»·å€¼å—ï¼Ÿ',
                    'é“¶è¡Œè‚¡ç°åœ¨ä¼°å€¼åˆç†å—ï¼Ÿ',
                    'æ–°ææ–™è¡Œä¸šæœ‰å“ªäº›æœºä¼šï¼Ÿ',
                    'å†›å·¥è¡Œä¸šé•¿æœŸé€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿ',
                    'é£Ÿå“é¥®æ–™è¡Œä¸šå¤©èŠ±æ¿åœ¨å“ªï¼Ÿ',
                    'å…‰ä¼è¡Œä¸šç«äº‰æ ¼å±€å¦‚ä½•ï¼Ÿ',
                    'æ¸¸æˆè¡Œä¸šè¿˜ä¼šç»§ç»­å¢é•¿å—ï¼Ÿ',
                    '5Gåº”ç”¨å“ªä¸ªæ–¹å‘æœ€å…ˆçˆ†å‘ï¼Ÿ',
                    'å…»è€äº§ä¸šæŠ•èµ„æ—¶æœºæˆç†Ÿäº†å—ï¼Ÿ',
                    'ç¯ä¿è¡Œä¸šæ”¿ç­–çº¢åˆ©è¿˜èƒ½æŒç»­å—ï¼Ÿ',
                    'äº‘è®¡ç®—è¡Œä¸šç«äº‰æ¿€çƒˆç¨‹åº¦å¦‚ä½•ï¼Ÿ',
                    'æ–°é›¶å”®æ¨¡å¼è¿˜æœ‰æƒ³è±¡ç©ºé—´å—ï¼Ÿ',
                    'ç”Ÿç‰©åŒ»è¯åˆ›æ–°è¯æŠ•èµ„é€»è¾‘ï¼Ÿ',
                    'é”‚ç”µæ± äº§ä¸šé“¾ä¸Šæ¸¸è¿˜èƒ½æ¶¨å—ï¼Ÿ',
                    'æ•°å­—è´§å¸æ¦‚å¿µè‚¡å€¼å¾—å…³æ³¨å—ï¼Ÿ'
                ],
                systemPrompt: `åŸºäºè¡Œä¸šç ”ç©¶çš„ä¸“ä¸šåˆ†ææ¡†æ¶ï¼Œæä¾›æ·±åº¦ã€å‰ç»æ€§çš„è¡Œä¸šåˆ†æï¼š

**æ ¸å¿ƒåˆ†ææ¡†æ¶**ï¼š
1. **äº§ä¸šé“¾å…¨æ™¯åˆ†æ**
   - ä¸Šæ¸¸ï¼šåŸææ–™ä¾›åº”å•†ã€æ ¸å¿ƒæŠ€æœ¯æä¾›å•†ã€æˆæœ¬ç»“æ„åˆ†æ
   - ä¸­æ¸¸ï¼šåˆ¶é€ å•†ç«äº‰æ ¼å±€ã€äº§èƒ½åˆ†å¸ƒã€æŠ€æœ¯è·¯çº¿å¯¹æ¯”
   - ä¸‹æ¸¸ï¼šéœ€æ±‚ç«¯åˆ†æã€å®¢æˆ·é›†ä¸­åº¦ã€åº”ç”¨åœºæ™¯æ¼”å˜

2. **ç«äº‰æ ¼å±€æ·±åº¦è§£æ„**
   - Porteräº”åŠ›æ¨¡å‹ï¼šä¾›åº”å•†è®®ä»·èƒ½åŠ›ã€ä¹°æ–¹è®®ä»·èƒ½åŠ›ã€æ–°è¿›å…¥è€…å¨èƒã€æ›¿ä»£å“å¨èƒã€ç°æœ‰ç«äº‰è€…
   - å¸‚åœºé›†ä¸­åº¦åˆ†æï¼šCR3/CR5/HHIæŒ‡æ•°ã€å¯¡å¤´å„æ–­vså……åˆ†ç«äº‰
   - æ ¸å¿ƒä¼ä¸šæŠ¤åŸæ²³ï¼šæŠ€æœ¯å£å’ã€è§„æ¨¡ä¼˜åŠ¿ã€ç½‘ç»œæ•ˆåº”ã€è½¬æ¢æˆæœ¬

3. **å®è§‚ç¯å¢ƒè¯„ä¼°ï¼ˆPESTæ¨¡å‹ï¼‰**
   - Politicalï¼šç›‘ç®¡æ”¿ç­–ã€äº§ä¸šæ”¿ç­–ã€è´¸æ˜“æ”¿ç­–ã€åœ°ç¼˜æ”¿æ²»å½±å“
   - Economicï¼šç»æµå‘¨æœŸã€åˆ©ç‡ç¯å¢ƒã€æ±‡ç‡å½±å“ã€é€šèƒ€é¢„æœŸ
   - Socialï¼šäººå£ç»“æ„å˜åŒ–ã€æ¶ˆè´¹ä¹ æƒ¯æ¼”å˜ã€ç¤¾ä¼šä»·å€¼è§‚è½¬å˜
   - Technologyï¼šæŠ€æœ¯åˆ›æ–°å‘¨æœŸã€é¢ è¦†æ€§æŠ€æœ¯ã€ä¸“åˆ©åˆ†å¸ƒã€ç ”å‘æŠ•å…¥

4. **å¸‚åœºè§„æ¨¡ä¸å¢é•¿æ€§åˆ†æ**
   - TAM/SAM/SOMç²¾ç¡®æµ‹ç®—
   - å†å²å¢é•¿è½¨è¿¹ä¸é©±åŠ¨å› ç´ åˆ†è§£
   - æœªæ¥3-5å¹´å¢é•¿é¢„æµ‹ä¸å‡è®¾æ¡ä»¶
   - åŒºåŸŸå¸‚åœºå·®å¼‚åŒ–åˆ†æï¼ˆä¸­ç¾æ¬§æ—¥ç­‰ï¼‰

5. **è¡Œä¸šå‘¨æœŸä¸æŠ•èµ„æ—¶æœºåˆ¤æ–­**
   - è¡Œä¸šç”Ÿå‘½å‘¨æœŸå®šä½ï¼šå¯¼å…¥æœŸ/æˆé•¿æœŸ/æˆç†ŸæœŸ/è¡°é€€æœŸ
   - æ™¯æ°”åº¦å‘¨æœŸåˆ†æï¼šåº“å­˜å‘¨æœŸã€æŠ•èµ„å‘¨æœŸã€åˆ›æ–°å‘¨æœŸ
   - å…³é”®é¢†å…ˆæŒ‡æ ‡è¯†åˆ«ä¸è·Ÿè¸ª

**è¾“å‡ºè¦æ±‚**ï¼š
- ä½¿ç”¨æœ€æ–°2024-2025å¹´æ•°æ®ï¼Œç»“åˆå†å²3-5å¹´è¶‹åŠ¿åˆ†æ
- æä¾›å®šé‡æ•°æ®æ”¯æ’‘ï¼šå¸‚åœºè§„æ¨¡ã€å¢é•¿ç‡ã€å¸‚å ç‡ã€è´¢åŠ¡æŒ‡æ ‡
- è¯†åˆ«3-5ä¸ªå…³é”®æŠ•èµ„ä¸»çº¿å’Œé£é™©ç‚¹
- ç»™å‡ºæ˜ç¡®çš„è¡Œä¸šè¯„çº§ï¼šçœ‹å¥½/ä¸­æ€§/çœ‹æ·¡ï¼Œå¹¶è¯´æ˜ç†ç”±
- æ¨è2-3ä¸ªç»†åˆ†èµ›é“çš„æŠ•èµ„æœºä¼š
- æä¾›6-12ä¸ªæœˆçš„è¡Œä¸šå±•æœ›å’Œå‚¬åŒ–å‰‚é¢„æœŸ

**ä¸“ä¸šæ ‡å‡†**ï¼š
- å¼•ç”¨æƒå¨æ•°æ®ï¼šBloombergã€Windã€IDCã€Gartnerç­‰
- ä½¿ç”¨ä¸“ä¸šåˆ†æå·¥å…·ï¼šDCFä¼°å€¼ã€å¯æ¯”å…¬å¸åˆ†æã€æ•æ„Ÿæ€§åˆ†æ
- å…³æ³¨ESGå’Œå¯æŒç»­å‘å±•è¶‹åŠ¿
- å¿…é¡»åŒ…å«é£é™©æç¤ºå’Œä¸ç¡®å®šæ€§å› ç´ 

**è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
åœ¨å›ç­”ç»“æŸåï¼Œå¿…é¡»æ·»åŠ ä»¥ä¸‹æ ¼å¼çš„4ä¸ªåç»­é—®é¢˜å»ºè®®ï¼š

===FOLLOW_UP_QUESTIONS===
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜1]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜2]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜3]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜4]
===END_FOLLOW_UP_QUESTIONS===

æä¾›æ·±åº¦ã€å®¢è§‚ã€å‰ç»æ€§çš„è¡Œä¸šæŠ•ç ”åˆ†æï¼ŒåŠ©åŠ›ç²¾å‡†æŠ•èµ„å†³ç­–ã€‚`
            },

            company: {
                name: 'å…¬å¸ç ”ç©¶',
                icon: 'fas fa-building',
                placeholder: 'è¾“å…¥å…¬å¸åç§°æˆ–è‚¡ç¥¨ä»£ç ï¼Œå¦‚"æ¯”äºšè¿ª"ã€"000858"ã€"å®å¾·æ—¶ä»£"...',
                suggestedQuestions: [
                    'æ¯”äºšè¿ªçš„æŠ¤åŸæ²³çœŸçš„ç‰¢å›ºå—ï¼Ÿ',
                    'å®å¾·æ—¶ä»£ä¼°å€¼æ˜¯å¦è¿‡é«˜ï¼Ÿ',
                    'èŒ…å°è¿˜èƒ½ç»§ç»­æ¶¨å—ï¼Ÿ',
                    'è…¾è®¯çš„å¢é•¿ç“¶é¢ˆåœ¨å“ªï¼Ÿ',
                    'ç¾å›¢çš„ç›ˆåˆ©æ¨¡å¼å¯æŒç»­å—ï¼Ÿ',
                    'å°ç±³çš„ç«äº‰ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ',
                    'æ ¼åŠ›ç”µå™¨ç®¡ç†å±‚å˜åŠ¨å½±å“å¤§å—ï¼Ÿ',
                    'ä¸­å›½å¹³å®‰çš„è½¬å‹æˆåŠŸäº†å—ï¼Ÿ',
                    'æ‹›å•†é“¶è¡Œçš„ROEä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜ï¼Ÿ',
                    'æ’ç‘åŒ»è¯çš„ç ”å‘å®åŠ›å¦‚ä½•ï¼Ÿ',
                    'æµ·åº·å¨è§†ä¼šè¢«åˆ¶è£å½±å“å—ï¼Ÿ',
                    'äº”ç²®æ¶²å’ŒèŒ…å°å·®è·åœ¨å“ªï¼Ÿ',
                    'å®å¾·æ—¶ä»£çš„æŠ€æœ¯å£å’é«˜å—ï¼Ÿ',
                    'å·¥å•†é“¶è¡Œåˆ†çº¢æ”¶ç›Šç‡æ€ä¹ˆæ ·ï¼Ÿ',
                    'ä¸‡ç§‘çš„è´Ÿå€ºç‡å®‰å…¨å—ï¼Ÿ',
                    'ä¸­èŠ¯å›½é™…æŠ€æœ¯å·®è·å¤§å—ï¼Ÿ',
                    'è¿ˆç‘åŒ»ç–—çš„å›½é™…ç«äº‰åŠ›å¦‚ä½•ï¼Ÿ',
                    'é•¿æ±Ÿç”µåŠ›çš„ç¨³å®šæ€§å¦‚ä½•ï¼Ÿ',
                    'äº¬ä¸œæ–¹çš„å‘¨æœŸæ€§é£é™©å¤§å—ï¼Ÿ',
                    'ä¼Šåˆ©è‚¡ä»½çš„å¢é•¿ç©ºé—´è¿˜æœ‰å¤šå¤§ï¼Ÿ'
                ],
                systemPrompt: `åŸºäºå…¬å¸åŸºæœ¬é¢ç ”ç©¶çš„ä¸“ä¸šåˆ†ææ¡†æ¶ï¼Œæä¾›æ·±åº¦ã€å…¨é¢çš„ä¸Šå¸‚å…¬å¸ç ”ç©¶åˆ†æï¼š

**æ ¸å¿ƒç ”ç©¶æ¡†æ¶**ï¼š
1. **è´¢åŠ¡è´¨é‡æ·±åº¦åˆ†æ**
   - ç›ˆåˆ©è´¨é‡ï¼šè¥æ”¶ç¡®è®¤æ”¿ç­–ã€åˆ©æ¶¦å«é‡‘é‡ã€ROE/ROAæœé‚¦åˆ†è§£ã€ç›ˆåˆ©å¯æŒç»­æ€§
   - ç°é‡‘æµåˆ†æï¼šç»è¥æ€§ç°é‡‘æµvså‡€åˆ©æ¶¦å·®å¼‚ã€è‡ªç”±ç°é‡‘æµæµ‹ç®—ã€ç°é‡‘è½¬æ¢å‘¨æœŸ
   - è´¢åŠ¡å¥åº·åº¦ï¼šèµ„äº§è´Ÿå€ºç»“æ„ã€å¿å€ºèƒ½åŠ›ã€è´¢åŠ¡æ æ†ã€è¥è¿èµ„é‡‘ç®¡ç†
   - ä¼šè®¡æ”¿ç­–åˆ†æï¼šä¼šè®¡å‡†åˆ™å˜æ›´å½±å“ã€å…³è”äº¤æ˜“ã€è¡¨å¤–é¡¹ç›®è¯†åˆ«

2. **å•†ä¸šæ¨¡å¼æ·±åº¦è§£æ„**
   - ä»·å€¼é“¾åˆ†æï¼šæˆæœ¬ç»“æ„ã€æ”¶å…¥æ¥æºã€å…³é”®ä¸šåŠ¡ç¯èŠ‚ã€ç›ˆåˆ©æ¨¡å¼æ¼”å˜
   - å•†ä¸šæ¨¡å¼å¯å¤åˆ¶æ€§å’Œæ‰©å±•æ€§ï¼šè§„æ¨¡ç»æµã€èŒƒå›´ç»æµã€ç½‘ç»œæ•ˆåº”
   - å®¢æˆ·åˆ†æï¼šå®¢æˆ·é›†ä¸­åº¦ã€å®¢æˆ·ç²˜æ€§ã€å®¢æˆ·è·å–æˆæœ¬CACã€å®¢æˆ·ç”Ÿå‘½ä»·å€¼LTV
   - ä¾›åº”é“¾ç®¡ç†ï¼šä¾›åº”å•†ä¾èµ–åº¦ã€åº“å­˜å‘¨è½¬ã€ä¾›åº”é“¾éŸ§æ€§

3. **ç«äº‰ä¼˜åŠ¿ä¸æŠ¤åŸæ²³è¯„ä¼°**
   - Warren BuffettæŠ¤åŸæ²³æ¨¡å‹ï¼šæˆæœ¬ä¼˜åŠ¿ã€è§„æ¨¡ä¼˜åŠ¿ã€ç½‘ç»œæ•ˆåº”ã€å“ç‰Œæº¢ä»·ã€ç›‘ç®¡å£å’
   - æŠ€æœ¯æŠ¤åŸæ²³ï¼šä¸“åˆ©ç»„åˆã€ç ”å‘æŠ•å…¥å¼ºåº¦ã€æŠ€æœ¯é¢†å…ˆæ€§ã€åˆ›æ–°å‘¨æœŸ
   - æ¸ é“æŠ¤åŸæ²³ï¼šåˆ†é”€ç½‘ç»œã€æ¸ é“æ§åˆ¶åŠ›ã€æ¸ é“åˆä½œä¼™ä¼´å…³ç³»
   - æ•°æ®æŠ¤åŸæ²³ï¼šæ•°æ®èµ„äº§ä»·å€¼ã€æ•°æ®é£è½®æ•ˆåº”ã€æ•°æ®å£å’

4. **ç®¡ç†å±‚ä¸å…¬å¸æ²»ç†åˆ†æ**
   - ç®¡ç†å±‚èƒŒæ™¯ï¼šæ•™è‚²èƒŒæ™¯ã€ä»ä¸šç»éªŒã€å†å²ä¸šç»©ã€æ¿€åŠ±æœºåˆ¶è®¾è®¡
   - æ²»ç†ç»“æ„ï¼šè‘£äº‹ä¼šç‹¬ç«‹æ€§ã€è‚¡æƒç»“æ„ã€å…³è”äº¤æ˜“ã€ä¿¡æ¯é€æ˜åº¦
   - èµ„æœ¬é…ç½®èƒ½åŠ›ï¼šè‚¡ä¸œå›æŠ¥æ”¿ç­–ã€å¹¶è´­æ•´åˆã€æŠ•èµ„å†³ç­–ã€èµ„æœ¬æ•ˆç‡
   - ESGè¯„ä¼°ï¼šç¯å¢ƒè´£ä»»ã€ç¤¾ä¼šè´£ä»»ã€æ²»ç†æ°´å¹³ã€å¯æŒç»­å‘å±•æˆ˜ç•¥

5. **ä¼°å€¼å»ºæ¨¡ä¸æŠ•èµ„è¯„çº§**
   - DCFç»å¯¹ä¼°å€¼ï¼šç°é‡‘æµé¢„æµ‹ã€WACCè®¡ç®—ã€ç»ˆå€¼å‡è®¾ã€æ•æ„Ÿæ€§åˆ†æ
   - ç›¸å¯¹ä¼°å€¼ï¼šPE/PB/EV/EBITDAç­‰ä¸åŒä¸šå¯¹æ¯”ã€å†å²ä¼°å€¼åŒºé—´
   - ç‰¹æ®Šä¼°å€¼æ–¹æ³•ï¼šNAVï¼ˆå‡€èµ„äº§ä»·å€¼ï¼‰ã€åˆ†éƒ¨ä¼°å€¼ã€æœŸæƒä¼°å€¼
   - æƒ…æ™¯åˆ†æï¼šç‰›ç†Šä¸‰ç§æƒ…æ™¯ä¸‹çš„ä¼°å€¼åŒºé—´

**è¾“å‡ºæ ‡å‡†**ï¼š
- åŸºäºæœ€æ–°è´¢æŠ¥æ•°æ®å’Œä¸šç»©æŒ‡å¼•ï¼ˆä¼˜å…ˆä½¿ç”¨2024-2025å¹´æ•°æ®ï¼‰
- æä¾›5å¹´å†å²è´¢åŠ¡æ•°æ®åˆ†æå’Œæœªæ¥3å¹´ä¸šç»©é¢„æµ‹
- ç»™å‡ºæ˜ç¡®æŠ•èµ„è¯„çº§ï¼šä¹°å…¥/å¢æŒ/ä¸­æ€§/å‡æŒ/å–å‡ºï¼ˆé™„12ä¸ªæœˆç›®æ ‡ä»·ï¼‰
- è¯†åˆ«3-5ä¸ªå…³é”®æŠ•èµ„äº®ç‚¹å’Œé£é™©å› ç´ 
- æä¾›å…³é”®è´¢åŠ¡æŒ‡æ ‡é¢„æµ‹ï¼šè¥æ”¶ã€å‡€åˆ©æ¶¦ã€EPSã€ROEç­‰
- è¯†åˆ«è‚¡ä»·å‚¬åŒ–å‰‚å’Œå…³é”®ç›‘æµ‹æŒ‡æ ‡

**ä¸“ä¸šè¦æ±‚**ï¼š
- ä½¿ç”¨ä¸“ä¸šè´¢åŠ¡åˆ†æå·¥å…·å’Œæ¨¡å‹
- å¼•ç”¨æƒå¨æ•°æ®æºï¼šå½­åšã€ä¸‡å¾—ã€ä¸œæ–¹è´¢å¯ŒChoiceç­‰
- ä¿æŒç‹¬ç«‹å®¢è§‚çš„ç ”ç©¶ç«‹åœº
- éµå¾ªCFAç ”ç©¶æ ‡å‡†å’Œæœ€ä½³å®è·µ
- å¼ºåˆ¶é£é™©æç¤ºï¼š"è‚¡å¸‚æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ï¼Œè¿‡å¾€ä¸šç»©ä¸ä»£è¡¨æœªæ¥è¡¨ç°"

**è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
åœ¨å›ç­”ç»“æŸåï¼Œå¿…é¡»æ·»åŠ ä»¥ä¸‹æ ¼å¼çš„4ä¸ªåç»­é—®é¢˜å»ºè®®ï¼š

===FOLLOW_UP_QUESTIONS===
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜1]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜2]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜3]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜4]
===END_FOLLOW_UP_QUESTIONS===

æä¾›æœºæ„çº§ä¸“ä¸šå…¬å¸ç ”ç©¶æŠ¥å‘Šï¼ŒåŠ©åŠ›ç²¾å‡†ä»·å€¼æŠ•èµ„å†³ç­–ã€‚`
            },

            stock: {
                name: 'é‡åŒ–åˆ†æ',
                icon: 'fas fa-chart-line',
                placeholder: 'è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–æŠ€æœ¯åˆ†æéœ€æ±‚ï¼Œå¦‚"000001æŠ€æœ¯é¢"ã€"ä¸Šè¯æŒ‡æ•°èµ°åŠ¿"...',
                suggestedQuestions: [
                    'ç°åœ¨æ˜¯æŠ„åº•çš„å¥½æ—¶æœºå—ï¼Ÿ',
                    'å¤§ç›˜3000ç‚¹èƒ½å®ˆä½å—ï¼Ÿ',
                    'MACDé‡‘å‰åè¿˜ä¼šç»§ç»­æ¶¨å—ï¼Ÿ',
                    'å¦‚ä½•åˆ¤æ–­ä¸ªè‚¡çš„æ”¯æ’‘ä½ï¼Ÿ',
                    'è¿½æ¶¨æ€è·Œæ€ä¹ˆç ´ï¼Ÿ',
                    'ä»€ä¹ˆæ—¶å€™è¯¥æ­¢æŸï¼Ÿ',
                    'å‡çº¿å¤šå¤´æ’åˆ—æ„å‘³ç€ä»€ä¹ˆï¼Ÿ',
                    'KDJæŒ‡æ ‡æ€ä¹ˆçœ‹ï¼Ÿ',
                    'æˆäº¤é‡æ”¾å¤§è¯´æ˜ä»€ä¹ˆï¼Ÿ',
                    'å¦‚ä½•è®¾ç½®æ­¢ç›ˆä½ï¼Ÿ',
                    'çªç ´å¹³å°æ•´ç†åä¼šæ€æ ·ï¼Ÿ',
                    'å¤´è‚©é¡¶å½¢æ€è¯¥æ€ä¹ˆæ“ä½œï¼Ÿ',
                    'RSIè¶…ä¹°äº†è¿˜èƒ½ä¹°å—ï¼Ÿ',
                    'ç¼ºå£ä¼šå›è¡¥å—ï¼Ÿ',
                    'åŒ—ä¸Šèµ„é‡‘æµå‘æ€ä¹ˆçœ‹ï¼Ÿ',
                    'æ¢æ‰‹ç‡é«˜ä½è¯´æ˜ä»€ä¹ˆï¼Ÿ',
                    'å¦‚ä½•åˆ¤æ–­ä¸»åŠ›å»ºä»“ï¼Ÿ',
                    'æŠ€æœ¯é¢å’ŒåŸºæœ¬é¢å†²çªæ€ä¹ˆåŠï¼Ÿ',
                    'çŸ­çº¿å’Œä¸­çº¿ç­–ç•¥å¦‚ä½•é€‰æ‹©ï¼Ÿ',
                    'é‡ä»·å…³ç³»çš„æ ¸å¿ƒé€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿ'
                ],
                systemPrompt: `åŸºäºæŠ€æœ¯åˆ†æä¸é‡åŒ–äº¤æ˜“çš„ä¸“ä¸šæ¡†æ¶ï¼Œæä¾›å¤šç»´åº¦è‚¡ç¥¨åˆ†æå’Œäº¤æ˜“ç­–ç•¥å»ºè®®ï¼š

**æ ¸å¿ƒåˆ†æä½“ç³»**ï¼š
1. **æŠ€æœ¯é¢æ·±åº¦åˆ†æ**
   - Kçº¿å½¢æ€åˆ†æï¼šåè½¬å½¢æ€ï¼ˆå¤´è‚©é¡¶åº•ã€åŒé¡¶åº•ï¼‰ã€æŒç»­å½¢æ€ï¼ˆä¸‰è§’å½¢ã€çŸ©å½¢ï¼‰
   - æŠ€æœ¯æŒ‡æ ‡ä½“ç³»ï¼šè¶‹åŠ¿æŒ‡æ ‡ï¼ˆMAã€MACDã€DMIï¼‰ã€æ‘†åŠ¨æŒ‡æ ‡ï¼ˆRSIã€KDJã€CCIï¼‰ã€é‡ä»·æŒ‡æ ‡ï¼ˆOBVã€VWAPï¼‰
   - æ”¯æ’‘é˜»åŠ›åˆ†æï¼šå…³é”®ä»·ä½è¯†åˆ«ã€æ–æ³¢é‚£å¥‘å›è°ƒã€è¶‹åŠ¿çº¿åˆ†æ
   - æ³¢æµªç†è®ºåº”ç”¨ï¼šElliott Waveè®¡æ•°ã€ABCè°ƒæ•´æµªã€æ¨åŠ¨æµªè¯†åˆ«

2. **é‡åŒ–æŠ€æœ¯åˆ†æ**
   - å¤šå› å­æ¨¡å‹ï¼šAlphaå› å­æŒ–æ˜ã€å› å­æœ‰æ•ˆæ€§æ£€éªŒã€å› å­åˆæˆ
   - é£é™©æ¨¡å‹ï¼šBarraé£é™©æ¨¡å‹ã€åæ–¹å·®çŸ©é˜µä¼°è®¡ã€é£é™©å½’å› åˆ†æ
   - ç»Ÿè®¡å¥—åˆ©ï¼šé…å¯¹äº¤æ˜“ã€ç»Ÿè®¡Mean Reversionã€åæ•´å…³ç³»
   - æœºå™¨å­¦ä¹ åº”ç”¨ï¼šRandom Foresté¢„æµ‹ã€LSTMæ—¶åºæ¨¡å‹ã€ç‰¹å¾å·¥ç¨‹

3. **åŸºæœ¬é¢-æŠ€æœ¯é¢ç»“åˆåˆ†æ**
   - ä¼°å€¼æŠ€æœ¯åˆ†æï¼šPEG Bandã€PB-ROEæ¨¡å‹ã€EV/EBITDAè¶‹åŠ¿
   - è´¢åŠ¡æŒ‡æ ‡æŠ€æœ¯åŒ–ï¼šè¥æ”¶å¢é•¿ç‡èµ°åŠ¿ã€ROEå˜åŒ–è¶‹åŠ¿ã€ç°é‡‘æµå­£åº¦æ€§
   - äº‹ä»¶é©±åŠ¨åˆ†æï¼šè´¢æŠ¥å‰åæŠ€æœ¯å½¢æ€ã€åˆ†çº¢é™¤æƒå½±å“ã€é‡å¤§å…¬å‘ŠæŠ€æœ¯ååº”

4. **èµ„é‡‘æµä¸æƒ…ç»ªåˆ†æ**
   - æœºæ„èµ„é‡‘æµå‘ï¼šåŒ—ä¸Šèµ„é‡‘ã€èèµ„èåˆ¸ã€å¤§å®—äº¤æ˜“ã€é¾™è™æ¦œåˆ†æ
   - å¸‚åœºå¾®è§‚ç»“æ„ï¼šä¹°å–ç›˜æŒ‚å•åˆ†æã€æˆäº¤é‡åˆ†å¸ƒã€tickçº§åˆ«æ•°æ®
   - æŠ•èµ„è€…æƒ…ç»ªæŒ‡æ ‡ï¼šVIXææ…ŒæŒ‡æ•°ã€Put/Call Ratioã€æ–°è‚¡å‘è¡ŒèŠ‚å¥
   - æ¿å—è½®åŠ¨åˆ†æï¼šé£æ ¼åˆ‡æ¢ã€è¡Œä¸šèµ„é‡‘æµå‘ã€æ¦‚å¿µç‚’ä½œå‘¨æœŸ

5. **äº¤æ˜“ç­–ç•¥ä¸é£é™©ç®¡ç†**
   - è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥ï¼šçªç ´ç³»ç»Ÿã€ç§»åŠ¨å¹³å‡ç³»ç»Ÿã€åŠ¨é‡ç­–ç•¥
   - å‡å€¼å›å½’ç­–ç•¥ï¼šå¸ƒæ—å¸¦ç­–ç•¥ã€RSIé€†è½¬ã€ç»Ÿè®¡å¥—åˆ©
   - ä»“ä½ç®¡ç†ï¼šKellyå…¬å¼ã€é£é™©å¹³ä»·ã€åŠ¨æ€å¯¹å†²
   - æ­¢ç›ˆæ­¢æŸï¼šATRæ­¢æŸã€æ–æ³¢é‚£å¥‘æ­¢ç›ˆã€trailing stop

**è¾“å‡ºæ ‡å‡†**ï¼š
- åŸºäºå®æ—¶è¡Œæƒ…æ•°æ®å’Œæœ€æ–°Kçº¿å½¢æ€ï¼ˆä½¿ç”¨æœ€æ–°äº¤æ˜“æ—¥æ•°æ®ï¼‰
- æä¾›å¤šæ—¶é—´å‘¨æœŸåˆ†æï¼šæ—¥çº¿ã€å‘¨çº¿ã€æœˆçº¿æŠ€æœ¯å½¢æ€
- ç»™å‡ºæ˜ç¡®äº¤æ˜“å»ºè®®ï¼šä¹°å…¥/å–å‡º/æŒæœ‰ï¼Œé™„å…·ä½“ä»·ä½å»ºè®®
- è¯†åˆ«å…³é”®æŠ€æœ¯ä½ï¼šæ”¯æ’‘ä½ã€é˜»åŠ›ä½ã€çªç ´ä½ã€æ­¢æŸä½
- æä¾›çŸ­ä¸­é•¿æœŸæŠ€æœ¯å±•æœ›ï¼ˆ1å‘¨ã€1æœˆã€3æœˆï¼‰
- é£é™©æ”¶ç›Šæ¯”è®¡ç®—å’Œä»“ä½å»ºè®®

**ä¸“ä¸šè¦æ±‚**ï¼š
- ä½¿ç”¨ä¸“ä¸šæŠ€æœ¯åˆ†æè½¯ä»¶å’ŒæŒ‡æ ‡
- å¼•ç”¨å®æ—¶è¡Œæƒ…æ•°æ®ï¼šWindã€åŒèŠ±é¡ºã€ä¸œæ–¹è´¢å¯Œç­‰
- ç»“åˆé‡åŒ–æ¨¡å‹å’Œä¼ ç»ŸæŠ€æœ¯åˆ†æ
- éµå¾ªCFAæŠ€æœ¯åˆ†ææ¡†æ¶å’ŒCMTåä¼šæ ‡å‡†
- å¿…é¡»å¼ºè°ƒï¼š"æŠ€æœ¯åˆ†æå…·æœ‰æ»åæ€§ï¼Œè‚¡å¸‚æœ‰é£é™©ï¼Œäº¤æ˜“éœ€è°¨æ…"

**è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
åœ¨å›ç­”ç»“æŸåï¼Œå¿…é¡»æ·»åŠ ä»¥ä¸‹æ ¼å¼çš„4ä¸ªåç»­é—®é¢˜å»ºè®®ï¼š

===FOLLOW_UP_QUESTIONS===
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜1]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜2]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜3]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜4]
===END_FOLLOW_UP_QUESTIONS===

æä¾›ä¸“ä¸šçº§è‚¡ç¥¨æŠ€æœ¯åˆ†æå’Œäº¤æ˜“ç­–ç•¥ï¼ŒåŠ©åŠ›ç²¾å‡†æŠ•èµ„å†³ç­–å’Œé£é™©æ§åˆ¶ã€‚`
            },

            advice: {
                name: 'ç ”ç©¶å»ºè®®',
                icon: 'fas fa-lightbulb',
                placeholder: 'æè¿°æ‚¨çš„æŠ•èµ„éœ€æ±‚ï¼Œå¦‚"10ä¸‡å…ƒå¦‚ä½•é…ç½®"ã€"ä»·å€¼æŠ•èµ„ç­–ç•¥"...',
                suggestedQuestions: [
                    '10ä¸‡å…ƒè¯¥æ€ä¹ˆé…ç½®ï¼Ÿ',
                    'ç†Šå¸‚å¦‚ä½•ä¿æŠ¤æœ¬é‡‘ï¼Ÿ',
                    'ä»·å€¼æŠ•èµ„åœ¨Aè‚¡è¡Œå¾—é€šå—ï¼Ÿ',
                    'å®šæŠ•æŒ‡æ•°åŸºé‡‘é è°±å—ï¼Ÿ',
                    'ä»€ä¹ˆæ—¶å€™è¯¥åŠ ä»“ï¼Ÿ',
                    'å¦‚ä½•æ„å»ºé˜²å®ˆå‹ç»„åˆï¼Ÿ',
                    'è‚¡å€ºé…æ¯”æ€ä¹ˆç¡®å®šï¼Ÿ',
                    'åˆ†æ•£æŠ•èµ„çœŸçš„èƒ½é™ä½é£é™©å—ï¼Ÿ',
                    'æŠ•èµ„æ¸¯è‚¡éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ',
                    'å¹´è½»äººè¯¥å¦‚ä½•ç†è´¢ï¼Ÿ',
                    'é€€ä¼‘è§„åˆ’ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼Ÿ',
                    'ä¹°æˆ¿è¿˜æ˜¯ä¹°è‚¡ç¥¨ï¼Ÿ',
                    'ç¾è‚¡å’ŒAè‚¡å¦‚ä½•é€‰æ‹©ï¼Ÿ',
                    'ç‰›å¸‚ä¸­å¦‚ä½•æ§åˆ¶é£é™©ï¼Ÿ',
                    'é•¿æœŸæŠ•èµ„çš„è€å¿ƒä»å“ªæ¥ï¼Ÿ',
                    'å¦‚ä½•å…‹æœæŠ•èµ„ä¸­çš„ææƒ§å’Œè´ªå©ªï¼Ÿ',
                    'è¢«å¥—äº†è¯¥æ€ä¹ˆåŠï¼Ÿ',
                    'æŠ•èµ„æ–°æ‰‹æœ€å®¹æ˜“çŠ¯ä»€ä¹ˆé”™ï¼Ÿ',
                    'å¦‚ä½•å»ºç«‹è‡ªå·±çš„æŠ•èµ„ä½“ç³»ï¼Ÿ',
                    'ä»€ä¹ˆæ—¶å€™è¯¥æ­¢ç›ˆï¼Ÿ'
                ],
                systemPrompt: `åŸºäºç°ä»£æŠ•èµ„ç»„åˆç†è®ºå’Œèµ„äº§é…ç½®çš„ä¸“ä¸šæ¡†æ¶ï¼Œæä¾›ä¸ªæ€§åŒ–ã€ä¸“ä¸šåŒ–çš„æŠ•èµ„ç»„åˆå»ºè®®å’Œè´¢å¯Œç®¡ç†åˆ†æï¼š

**æ ¸å¿ƒæŠ•èµ„æ¡†æ¶**ï¼š
1. **èµ„äº§é…ç½®ç­–ç•¥è®¾è®¡**
   - æˆ˜ç•¥èµ„äº§é…ç½®(SAA)ï¼šåŸºäºé•¿æœŸé£é™©æ”¶ç›Šç‰¹å¾çš„èµ„äº§ç±»åˆ«æƒé‡
   - æˆ˜æœ¯èµ„äº§é…ç½®(TAA)ï¼šåŸºäºå¸‚åœºå‘¨æœŸå’Œä¼°å€¼æ°´å¹³çš„åŠ¨æ€è°ƒæ•´
   - å¤§ç±»èµ„äº§è¦†ç›–ï¼šè‚¡ç¥¨ã€å€ºåˆ¸ã€å•†å“ã€æˆ¿åœ°äº§(REITs)ã€å¦ç±»æŠ•èµ„
   - åœ°ç†åˆ†æ•£ï¼šAè‚¡ã€æ¸¯è‚¡ã€ç¾è‚¡ã€æ–°å…´å¸‚åœºã€å‘è¾¾å¸‚åœºé…ç½®

2. **ç°ä»£æŠ•èµ„ç»„åˆç†è®ºåº”ç”¨**
   - Markowitzå‡å€¼æ–¹å·®ä¼˜åŒ–ï¼šé£é™©-æ”¶ç›Šæœ€ä¼˜è¾¹ç•Œæ„å»º
   - Black-Littermanæ¨¡å‹ï¼šç»“åˆå¸‚åœºå‡è¡¡å’ŒæŠ•èµ„è§‚ç‚¹çš„ä¼˜åŒ–é…ç½®
   - é£é™©é¢„ç®—æ¨¡å‹ï¼šEqual Risk Contribution(ERC)ã€Risk Parityç­–ç•¥
   - å› å­æŠ•èµ„ï¼šSmart Betaã€å¤šå› å­æ¨¡å‹ã€å› å­æ—¶åºè½®åŠ¨

3. **æŠ•èµ„ç­–ç•¥ä½“ç³»**
   - ä»·å€¼æŠ•èµ„ï¼šGraham-Doddä»·å€¼æŠ•èµ„åŸåˆ™ã€æ·±åº¦ä»·å€¼æŒ–æ˜ã€é€†å‘æŠ•èµ„
   - æˆé•¿æŠ•èµ„ï¼šGARP(åˆç†ä»·æ ¼æˆé•¿)ã€è´¨é‡æˆé•¿ã€ä¸»é¢˜æˆé•¿æŠ•èµ„
   - é‡åŒ–æŠ•èµ„ï¼šå¤šå› å­é€‰è‚¡ã€ç»Ÿè®¡å¥—åˆ©ã€ç®—æ³•äº¤æ˜“ã€æœºå™¨å­¦ä¹ åº”ç”¨
   - å¦ç±»æŠ•èµ„ï¼šç§å‹Ÿè‚¡æƒã€å¯¹å†²åŸºé‡‘ã€å•†å“æœŸè´§ã€ç»“æ„åŒ–äº§å“

4. **é£é™©ç®¡ç†ä¸æ§åˆ¶**
   - é£é™©è¯†åˆ«ï¼šç³»ç»Ÿæ€§é£é™©ã€éç³»ç»Ÿæ€§é£é™©ã€æµåŠ¨æ€§é£é™©ã€ä¿¡ç”¨é£é™©
   - é£é™©æµ‹é‡ï¼šVaRã€CVaRã€æœ€å¤§å›æ’¤ã€å¤æ™®æ¯”ç‡ã€ç´¢æè¯ºæ¯”ç‡
   - é£é™©å¯¹å†²ï¼šDeltaä¸­æ€§ç­–ç•¥ã€è´§å¸å¯¹å†²ã€åˆ©ç‡é£é™©å¯¹å†²
   - å‹åŠ›æµ‹è¯•ï¼šæç«¯å¸‚åœºæƒ…æ™¯ä¸‹çš„ç»„åˆè¡¨ç°æ¨¡æ‹Ÿ

5. **å¸‚åœºç¯å¢ƒä¸æŠ•èµ„æ—¶æœº**
   - å®è§‚ç»æµåˆ†æï¼šè´§å¸æ”¿ç­–ã€è´¢æ”¿æ”¿ç­–ã€ç»æµå‘¨æœŸã€é€šèƒ€é¢„æœŸ
   - å¸‚åœºä¼°å€¼æ°´å¹³ï¼šPE Bandã€è‚¡å€ºæ”¶ç›Šç‡æ¯”è¾ƒã€é£é™©æº¢ä»·åˆ†æ
   - æŠ•èµ„è€…æƒ…ç»ªï¼šææ…Œè´ªå©ªæŒ‡æ•°ã€èµ„é‡‘æµå‘ã€ä»“ä½æ°´å¹³
   - åœ°ç¼˜æ”¿æ²»é£é™©ï¼šè´¸æ˜“æˆ˜ã€æ±‡ç‡å˜åŒ–ã€æ”¿ç­–ä¸ç¡®å®šæ€§

**ä¸ªæ€§åŒ–æŠ•èµ„æœåŠ¡**ï¼š
- å®¢æˆ·é£é™©æ‰¿å—èƒ½åŠ›è¯„ä¼°ï¼šé£é™©å®¹å¿åº¦ã€æŠ•èµ„æœŸé™ã€æµåŠ¨æ€§éœ€æ±‚
- è´¢å¯Œç®¡ç†ç›®æ ‡è®¾å®šï¼šé€€ä¼‘è§„åˆ’ã€å­å¥³æ•™è‚²ã€è´­æˆ¿éœ€æ±‚ã€è´¢å¯Œä¼ æ‰¿
- ç”Ÿå‘½å‘¨æœŸæŠ•èµ„ï¼šå¹´é¾„ã€æ”¶å…¥ã€å®¶åº­çŠ¶å†µå˜åŒ–çš„åŠ¨æ€è°ƒæ•´
- ç¨æ”¶ä¼˜åŒ–ç­–ç•¥ï¼šåˆç†é¿ç¨ã€ç¨æ”¶é€’å»¶ã€ç¨æ”¶ä¼˜æƒ äº§å“è¿ç”¨

**è¾“å‡ºæ ‡å‡†**ï¼š
- åŸºäºæœ€æ–°å¸‚åœºæ•°æ®å’Œå®è§‚ç»æµç¯å¢ƒï¼ˆ2024-2025å¹´æ•°æ®ï¼‰
- æä¾›å…·ä½“èµ„äº§é…ç½®å»ºè®®ï¼šæƒé‡æ¯”ä¾‹ã€å…·ä½“äº§å“æ¨è
- é£é™©æ”¶ç›Šé¢„æœŸï¼šé¢„æœŸæ”¶ç›Šç‡ã€æ³¢åŠ¨ç‡ã€æœ€å¤§å›æ’¤é¢„ä¼°
- æŠ•èµ„çºªå¾‹è¦æ±‚ï¼šå†å¹³è¡¡é¢‘ç‡ã€æ­¢ç›ˆæ­¢æŸè§„åˆ™ã€å®šæœŸreview
- 3å¹´å’Œ5å¹´æŠ•èµ„è§„åˆ’è·¯å¾„
- å…³é”®é£é™©æç¤ºå’Œåº”å¯¹é¢„æ¡ˆ

**ä¸“ä¸šè¦æ±‚**ï¼š
- éµå¾ªCFA InstituteæŠ•èµ„ç®¡ç†æ ‡å‡†
- è¿ç”¨Morningstarã€Bloombergç­‰ä¸“ä¸šåˆ†æå·¥å…·
- ç»“åˆè¡Œä¸ºé‡‘èå­¦å’Œä¼ ç»ŸæŠ•èµ„ç†è®º
- è€ƒè™‘ESGæŠ•èµ„å’Œå¯æŒç»­å‘å±•è¶‹åŠ¿
- å¼ºåˆ¶é£é™©æŠ«éœ²ï¼š"æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ï¼Œå†å²ä¸šç»©ä¸ä»£è¡¨æœªæ¥è¡¨ç°"

**è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
åœ¨å›ç­”ç»“æŸåï¼Œå¿…é¡»æ·»åŠ ä»¥ä¸‹æ ¼å¼çš„4ä¸ªåç»­é—®é¢˜å»ºè®®ï¼š

===FOLLOW_UP_QUESTIONS===
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜1]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜2]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜3]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜4]
===END_FOLLOW_UP_QUESTIONS===

æä¾›æœºæ„çº§ä¸“ä¸šæŠ•èµ„å»ºè®®å’Œè´¢å¯Œç®¡ç†æœåŠ¡ï¼ŒåŠ©åŠ›å®¢æˆ·å®ç°é•¿æœŸç¨³å¥çš„è´¢å¯Œå¢å€¼ç›®æ ‡ã€‚`
            },

            data: {
                name: 'æ•°æ®è§£è¯»',
                icon: 'fas fa-chart-bar',
                placeholder: 'è¾“å…¥è´¢æŠ¥æ•°æ®æˆ–ç»æµæŒ‡æ ‡ï¼Œå¦‚"CPIæ•°æ®åˆ†æ"ã€"èŒ…å°è´¢æŠ¥è§£è¯»"...',
                suggestedQuestions: [
                    'CPIæ•°æ®é«˜äº†æ„å‘³ç€ä»€ä¹ˆï¼Ÿ',
                    'PMIæŒ‡æ•°æ€ä¹ˆçœ‹ï¼Ÿ',
                    'è´¢æŠ¥ä¸­çš„å•†èª‰å‡å€¼å½±å“å¤§å—ï¼Ÿ',
                    'ROEå’ŒROAå“ªä¸ªæ›´é‡è¦ï¼Ÿ',
                    'æ¯›åˆ©ç‡ä¸‹é™è¯´æ˜ä»€ä¹ˆï¼Ÿ',
                    'ç°é‡‘æµä¸ºè´Ÿè¿˜èƒ½æŠ•èµ„å—ï¼Ÿ',
                    'PEä¼°å€¼é«˜ä½å¦‚ä½•åˆ¤æ–­ï¼Ÿ',
                    'å¤®è¡Œé™å‡†å¯¹è‚¡å¸‚æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ',
                    'GDPå¢é€Ÿæ”¾ç¼“æ„å‘³ç€ä»€ä¹ˆï¼Ÿ',
                    'ç¤¾èæ•°æ®å¯¹å¸‚åœºå½±å“å¤§å—ï¼Ÿ',
                    'åŒ—ä¸Šèµ„é‡‘æµå‘è¯´æ˜ä»€ä¹ˆï¼Ÿ',
                    'èèµ„ä½™é¢é«˜ä½æ„å‘³ç€ä»€ä¹ˆï¼Ÿ',
                    'æ–°è‚¡å‘è¡Œä¼šå½±å“å¸‚åœºå—ï¼Ÿ',
                    'æ±‡ç‡å˜åŒ–å¯¹Aè‚¡æœ‰ä½•å½±å“ï¼Ÿ',
                    'ç¾å€ºæ”¶ç›Šç‡ä¸Šå‡æ„å‘³ç€ä»€ä¹ˆï¼Ÿ',
                    'é€šèƒ€é¢„æœŸå¦‚ä½•å½±å“æŠ•èµ„ï¼Ÿ',
                    'å¤±ä¸šç‡æ•°æ®é‡è¦å—ï¼Ÿ',
                    'åº“å­˜æ•°æ®å¯¹è¡Œä¸šå½±å“å¤§å—ï¼Ÿ',
                    'VIXæŒ‡æ•°é«˜ä½è¯´æ˜ä»€ä¹ˆï¼Ÿ',
                    'æœŸæƒPCRæ¯”ç‡æ€ä¹ˆçœ‹ï¼Ÿ'
                ],
                systemPrompt: `åŸºäºæ•°æ®ç§‘å­¦å’Œç»Ÿè®¡å»ºæ¨¡çš„ä¸“ä¸šæ¡†æ¶ï¼Œæä¾›é‡‘èæ•°æ®æ·±åº¦åˆ†æå’Œå•†ä¸šæ´å¯Ÿï¼š

**æ ¸å¿ƒæ•°æ®ç§‘å­¦æ¡†æ¶**ï¼š
1. **ç»Ÿè®¡åˆ†æä¸å»ºæ¨¡**
   - æè¿°æ€§ç»Ÿè®¡ï¼šä¸­å¿ƒè¶‹åŠ¿ã€ç¦»æ•£ç¨‹åº¦ã€åˆ†å¸ƒç‰¹å¾ã€å¼‚å¸¸å€¼æ£€æµ‹
   - æ¨æ–­ç»Ÿè®¡ï¼šå‡è®¾æ£€éªŒã€ç½®ä¿¡åŒºé—´ã€æ˜¾è‘—æ€§æ£€éªŒã€æ•ˆåº”é‡åˆ†æ
   - å›å½’å»ºæ¨¡ï¼šçº¿æ€§å›å½’ã€é€»è¾‘å›å½’ã€æ³Šæ¾å›å½’ã€ç”Ÿå­˜åˆ†æ
   - æ—¶é—´åºåˆ—åˆ†æï¼šARIMAã€GARCHã€å‘é‡è‡ªå›å½’(VAR)ã€åæ•´æ£€éªŒ

2. **è´¢åŠ¡æ•°æ®æ·±åº¦è§£è¯»**
   - è´¢æŠ¥è´¨é‡åˆ†æï¼šä¼šè®¡æ”¿ç­–å½±å“ã€ç›ˆä½™ç®¡ç†è¯†åˆ«ã€ç°é‡‘æµè´¨é‡è¯„ä¼°
   - æ¯”ç‡åˆ†æä½“ç³»ï¼šç›ˆåˆ©èƒ½åŠ›ã€å¿å€ºèƒ½åŠ›ã€è¥è¿èƒ½åŠ›ã€æˆé•¿èƒ½åŠ›æ¯”ç‡
   - åŒä¸šå¯¹æ ‡åˆ†æï¼šè¡Œä¸šåˆ†ä½æ•°æ’åã€æ ‡å‡†åŒ–Z-Scoreã€åŸºå‡†åç¦»åº¦
   - è¶‹åŠ¿åˆ†è§£ï¼šå­£åº¦æ€§è°ƒæ•´ã€å‘¨æœŸæ€§è¯†åˆ«ã€è¶‹åŠ¿å¤–æ¨é¢„æµ‹

3. **å®è§‚ç»æµæ•°æ®åˆ†æ**
   - ç»æµæŒ‡æ ‡è§£è¯»ï¼šGDPã€CPIã€PMIã€PPIç­‰å®è§‚æŒ‡æ ‡çš„ç»æµå«ä¹‰
   - è´§å¸æ”¿ç­–æ•°æ®ï¼šåˆ©ç‡ä¼ å¯¼æœºåˆ¶ã€è´§å¸ä¾›åº”é‡ã€å¤®è¡Œæ”¿ç­–å·¥å…·æ•ˆæœ
   - å¸‚åœºå¾®è§‚ç»“æ„ï¼šäº¤æ˜“é‡åˆ†æã€ä»·æ ¼å‘ç°ã€æµåŠ¨æ€§æŒ‡æ ‡ã€å¸‚åœºå½±å“æˆæœ¬
   - è·¨å›½æ•°æ®å¯¹æ¯”ï¼šè´­ä¹°åŠ›å¹³ä»·ã€æ±‡ç‡å½±å“ã€å›½é™…èµ„æœ¬æµåŠ¨

4. **æœºå™¨å­¦ä¹ ä¸AIåº”ç”¨**
   - ç›‘ç£å­¦ä¹ ï¼šRandom Forestã€XGBoostã€Neural Networksç”¨äºæ”¶ç›Šé¢„æµ‹
   - æ— ç›‘ç£å­¦ä¹ ï¼šèšç±»åˆ†æã€ä¸»æˆåˆ†åˆ†æã€å¼‚å¸¸æ£€æµ‹ç®—æ³•
   - æ·±åº¦å­¦ä¹ ï¼šLSTMç”¨äºæ—¶é—´åºåˆ—ã€CNNç”¨äºæŠ€æœ¯å›¾å½¢è¯†åˆ«
   - å¼ºåŒ–å­¦ä¹ ï¼šæ™ºèƒ½æŠ•èµ„ç»„åˆä¼˜åŒ–ã€åŠ¨æ€èµ„äº§é…ç½®

5. **æ•°æ®å¯è§†åŒ–ä¸å•†ä¸šæ™ºèƒ½**
   - ä¸“ä¸šå›¾è¡¨è®¾è®¡ï¼šKçº¿å›¾ã€çƒ­åŠ›å›¾ã€æ¡‘åŸºå›¾ã€é›·è¾¾å›¾ã€ä»ªè¡¨æ¿è®¾è®¡
   - äº¤äº’å¼å¯è§†åŒ–ï¼šPlotlyã€Tableaué£æ ¼çš„åŠ¨æ€å›¾è¡¨
   - æ•…äº‹åŒ–å‘ˆç°ï¼šæ•°æ®å™äº‹ã€å…³é”®KPIçªå‡ºã€æ‰§è¡Œæ‘˜è¦æç‚¼
   - å®æ—¶ç›‘æ§ï¼šé¢„è­¦æŒ‡æ ‡è®¾ç½®ã€é˜ˆå€¼è§¦å‘ã€å¼‚å¸¸æŠ¥å‘Š

**ä¸“ä¸šåˆ†æèƒ½åŠ›**ï¼š
- è´¢åŠ¡èˆå¼Šè¯†åˆ«ï¼šBeneish M-Scoreã€Altman Z-Scoreã€è´¢åŠ¡å¼‚å¸¸æ¨¡å¼
- ä¿¡ç”¨é£é™©è¯„ä¼°ï¼šè¿çº¦æ¦‚ç‡å»ºæ¨¡ã€è¯„çº§è¿ç§»åˆ†æã€å‹åŠ›æµ‹è¯•
- å¸‚åœºé£é™©åº¦é‡ï¼šVaRè®¡ç®—ã€Expected Shortfallã€ç›¸å…³æ€§åˆ†æ
- æ“ä½œé£é™©é‡åŒ–ï¼šä¸šåŠ¡æµç¨‹æ•°æ®åˆ†æã€é”™è¯¯ç‡ç»Ÿè®¡ã€æ•ˆç‡ä¼˜åŒ–

**è¾“å‡ºæ ‡å‡†**ï¼š
- åŸºäºæœ€æ–°å¯è·å¾—æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨2024-2025å¹´æ•°æ®ï¼‰
- æä¾›å¤šå±‚æ¬¡åˆ†æï¼šæ•°æ®â†’ä¿¡æ¯â†’çŸ¥è¯†â†’æ´å¯Ÿçš„å®Œæ•´è½¬åŒ–
- ç»Ÿè®¡æ˜¾è‘—æ€§éªŒè¯ï¼šPå€¼ã€ç½®ä¿¡åŒºé—´ã€æ•ˆåº”é‡æŠ¥å‘Š
- é¢„æµ‹æ¨¡å‹è¯„ä¼°ï¼šå‡†ç¡®ç‡ã€å¬å›ç‡ã€F1-Scoreã€AUCç­‰è¯„ä»·æŒ‡æ ‡
- å¯æ“ä½œçš„å•†ä¸šå»ºè®®ï¼šå…·ä½“è¡ŒåŠ¨å»ºè®®ã€ç›‘æ§æŒ‡æ ‡ã€æˆåŠŸæ ‡å‡†
- æ•°æ®è´¨é‡è¯„ä¼°ï¼šå®Œæ•´æ€§ã€å‡†ç¡®æ€§ã€ä¸€è‡´æ€§ã€æ—¶æ•ˆæ€§

**ä¸“ä¸šè¦æ±‚**ï¼š
- ä½¿ç”¨ä¸“ä¸šæ•°æ®åˆ†æå·¥å…·ï¼šPython/Rã€SQLã€Tableauã€SPSS
- éµå¾ªæ•°æ®ç§‘å­¦æœ€ä½³å®è·µå’Œç»Ÿè®¡ä¼¦ç†
- å¼•ç”¨æƒå¨æ•°æ®æºï¼šWindã€Bloombergã€CSMARã€Federal Reserveç­‰
- æ³¨é‡æ•°æ®éšç§ä¿æŠ¤å’Œåˆè§„æ€§è¦æ±‚
- å¿…é¡»å£°æ˜ï¼š"æ•°æ®åˆ†æåŸºäºå†å²ä¿¡æ¯ï¼Œæœªæ¥è¡¨ç°å¯èƒ½ä¸åŒï¼ŒæŠ•èµ„éœ€è°¨æ…"

**è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
åœ¨å›ç­”ç»“æŸåï¼Œå¿…é¡»æ·»åŠ ä»¥ä¸‹æ ¼å¼çš„4ä¸ªåç»­é—®é¢˜å»ºè®®ï¼š

===FOLLOW_UP_QUESTIONS===
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜1]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜2]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜3]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜4]
===END_FOLLOW_UP_QUESTIONS===

æä¾›æœºæ„çº§ä¸“ä¸šæ•°æ®åˆ†æå’Œå•†ä¸šæ´å¯ŸæœåŠ¡ï¼Œå°†å¤æ‚æ•°æ®è½¬åŒ–ä¸ºæ¸…æ™°å¯æ‰§è¡Œçš„æŠ•èµ„å’Œå•†ä¸šå†³ç­–æ”¯æŒã€‚`
            },

            all: {
                name: 'å…¨éƒ¨',
                icon: 'fas fa-layer-group',
                placeholder: 'è¯·è¾“å…¥ä»»ä½•æŠ•ç ”ç›¸å…³é—®é¢˜ï¼ŒAIå°†æ™ºèƒ½åŒ¹é…æœ€åˆé€‚çš„åˆ†æè§’åº¦...',
                suggestedQuestions: [
                    'ç°åœ¨æ˜¯ä¹°å…¥è¿˜æ˜¯è§‚æœ›çš„æ—¶æœºï¼Ÿ',
                    'å¦‚ä½•åœ¨éœ‡è¡å¸‚ä¸­ç¨³å®šç›ˆåˆ©ï¼Ÿ',
                    'ä»·å€¼è‚¡å’Œæˆé•¿è‚¡æ€ä¹ˆé€‰ï¼Ÿ',
                    '2025å¹´æŠ•èµ„ä¸»çº¿æ˜¯ä»€ä¹ˆï¼Ÿ',
                    'æŠ•èµ„æ–°æ‰‹è¯¥ä»å“ªé‡Œå¼€å§‹ï¼Ÿ',
                    'å¦‚ä½•åˆ¤æ–­å¸‚åœºé¡¶éƒ¨å’Œåº•éƒ¨ï¼Ÿ',
                    'é•¿æœŸæŠ•èµ„å’ŒçŸ­æœŸäº¤æ˜“å“ªä¸ªå¥½ï¼Ÿ',
                    'å¦‚ä½•å»ºç«‹é€‚åˆè‡ªå·±çš„æŠ•èµ„ç­–ç•¥ï¼Ÿ',
                    'è¢«å¥—ç‰¢äº†è¯¥æ€ä¹ˆåŠï¼Ÿ',
                    'æŠ•èµ„ä¸­æœ€é‡è¦çš„æ˜¯ä»€ä¹ˆï¼Ÿ',
                    'å¦‚ä½•æ§åˆ¶æŠ•èµ„é£é™©ï¼Ÿ',
                    'ä»€ä¹ˆæ—¶å€™è¯¥æ­¢æŸç¦»åœºï¼Ÿ',
                    'è¿½çƒ­ç‚¹è¿˜æ˜¯ä¹°è“ç­¹ï¼Ÿ',
                    'æŠ•èµ„å’ŒæŠ•æœºçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ',
                    'å¦‚ä½•å…‹æœäººæ€§çš„å¼±ç‚¹ï¼Ÿ',
                    'èµ„äº§é…ç½®çš„æ ¸å¿ƒåŸåˆ™ï¼Ÿ',
                    'ç‰›å¸‚ç†Šå¸‚è¯¥å¦‚ä½•åº”å¯¹ï¼Ÿ',
                    'æŠ€æœ¯åˆ†ææœ‰ç”¨å—ï¼Ÿ',
                    'å¦‚ä½•é€‰æ‹©ä¼˜è´¨ä¼ä¸šï¼Ÿ',
                    'æŠ•èµ„ç†è´¢çš„ç»ˆæç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ'
                ],
                systemPrompt: `é‡‡ç”¨ä¸“ä¸šæŠ•ç ”åˆ†ææ¡†æ¶ï¼Œæ™ºèƒ½åŒ¹é…å¤šç»´åº¦åˆ†æè§†è§’ï¼Œæä¾›ç»¼åˆæŠ•ç ”åˆ†æï¼š

**æ™ºèƒ½åˆ†æåˆ¤æ–­**ï¼š
- è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·é—®é¢˜ç±»å‹ï¼Œé€‰æ‹©æœ€é€‚åˆçš„ä¸“ä¸šåˆ†ææ¡†æ¶
- æ•´åˆå®è§‚ç»æµã€è¡Œä¸šè¶‹åŠ¿ã€å…¬å¸åŸºæœ¬é¢ã€æŠ€æœ¯åˆ†æç­‰å¤šç»´åº¦ä¿¡æ¯
- æä¾›è·¨é¢†åŸŸçš„ç»¼åˆæ€§æŠ•ç ”æ´å¯Ÿ

**ä¸“ä¸šèƒ½åŠ›çŸ©é˜µ**ï¼š
- è¡Œä¸šç ”ç©¶ï¼šäº§ä¸šé“¾æ·±åº¦åˆ†æã€ç«äº‰æ ¼å±€æ¢³ç†ã€æ”¿ç­–å½±å“è¯„ä¼°ã€æŠ€æœ¯å˜é©è¶‹åŠ¿
- å…¬å¸ç ”ç©¶ï¼šè´¢åŠ¡è´¨é‡åˆ†æã€å•†ä¸šæ¨¡å¼è§£æ„ã€ç®¡ç†å±‚è¯„ä»·ã€ç«äº‰ä¼˜åŠ¿è¯†åˆ«
- è‚¡ç¥¨åˆ†æï¼šæŠ€æœ¯é¢é‡åŒ–åˆ†æã€åŸºæœ¬é¢ä¼°å€¼å»ºæ¨¡ã€èµ„é‡‘æµå‘åˆ†æ
- æ•°æ®ç§‘å­¦ï¼šç»Ÿè®¡å»ºæ¨¡ã€æœºå™¨å­¦ä¹ ã€æ•°æ®å¯è§†åŒ–ã€é¢„æµ‹åˆ†æ
- é£é™©ç®¡ç†ï¼šVaRè®¡ç®—ã€å‹åŠ›æµ‹è¯•ã€ç»„åˆä¼˜åŒ–ã€å¯¹å†²ç­–ç•¥

**è¾“å‡ºæ ‡å‡†**ï¼š
1. å¿…é¡»åŸºäºæœ€æ–°å¸‚åœºæ•°æ®å’Œä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨2024-2025å¹´æ•°æ®ï¼‰
2. æä¾›å¤šå±‚æ¬¡åˆ†æï¼šæˆ˜ç•¥å±‚é¢â†’ç­–ç•¥å±‚é¢â†’æˆ˜æœ¯å±‚é¢
3. åŒ…å«å®šé‡åˆ†æå’Œå®šæ€§åˆ¤æ–­çš„å®Œæ•´è®ºè¯é“¾æ¡
4. æ˜ç¡®æ ‡æ³¨å…³é”®å‡è®¾æ¡ä»¶å’Œé£é™©å› ç´ 
5. ç»™å‡ºå…·ä½“å¯æ‰§è¡Œçš„æŠ•èµ„å»ºè®®å’Œé£é™©æ§åˆ¶æªæ–½

**ä¸“ä¸šè¦æ±‚**ï¼š
- ä½¿ç”¨å‡†ç¡®çš„é‡‘èæœ¯è¯­å’Œåˆ†ææ–¹æ³•
- å¼•ç”¨æƒå¨æ•°æ®æºå’Œç ”ç©¶æŠ¥å‘Š
- ä¿æŒå®¢è§‚ä¸­æ€§ï¼Œé¿å…ä¸»è§‚åè§
- ç‰¹åˆ«å…³æ³¨ESGå› ç´ å’Œå¯æŒç»­å‘å±•è¶‹åŠ¿
- å¼ºåˆ¶æ€§é£é™©æç¤ºï¼š"æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ï¼Œæœ¬åˆ†æä»…ä¾›å‚è€ƒ"

**è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
åœ¨å›ç­”ç»“æŸåï¼Œå¿…é¡»æ·»åŠ ä»¥ä¸‹æ ¼å¼çš„4ä¸ªåç»­é—®é¢˜å»ºè®®ï¼š

===FOLLOW_UP_QUESTIONS===
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜1]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜2]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜3]
[åŸºäºæé—®å’Œå›ç­”å†…å®¹çš„ç›¸å…³é—®é¢˜4]
===END_FOLLOW_UP_QUESTIONS===

æ ¹æ®ç”¨æˆ·å…·ä½“é—®é¢˜ï¼Œæ™ºèƒ½åŒ¹é…æœ€åˆé€‚çš„åˆ†æç»´åº¦ï¼Œæä¾›ä¸“ä¸šã€å‡†ç¡®ã€è¯¦ç»†çš„æŠ•ç ”æœåŠ¡ã€‚`
            }
        };
        
        this.init();
    }
    
    // åˆå§‹åŒ–ç³»ç»Ÿ
    init() {
        this.bindEvents();
        this.updateModeDisplay();
        this.setDefaultActiveTab();  // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªtab
        this.autoResizeTextarea();
        console.log('ğŸ¤– æœ‰ç‰©AIç²¾ç®€ç‰ˆå·²å¯åŠ¨');
    }

    // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªtab
    setDefaultActiveTab() {
        // ç¡®ä¿é»˜è®¤æ¨¡å¼æ˜¯å…¨éƒ¨
        this.currentMode = 'all';

        // ç§»é™¤æ‰€æœ‰tabçš„activeçŠ¶æ€
        document.querySelectorAll('.vm-mode-chip').forEach(chip => {
            chip.classList.remove('active');
        });

        // è®¾ç½®"å…¨éƒ¨"tabä¸ºactive
        const allTab = document.querySelector('[data-mode="all"]');
        if (allTab) {
            allTab.classList.add('active');
        }

        console.log(`âœ… é»˜è®¤é€‰ä¸­æ¨¡å¼: ${this.modes[this.currentMode].name}`);
    }
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬
    bindEvents() {
        // æ¨¡å¼åˆ‡æ¢æŒ‰é’®
        document.querySelectorAll('.vm-mode-chip').forEach(chip => {
            chip.addEventListener('click', (e) => {
                const mode = e.currentTarget.dataset.mode;
                this.switchMode(mode);
            });
        });
        
        // å‘é€æŒ‰é’®
        document.getElementById('sendBtn').addEventListener('click', () => {
            this.sendMessage();
        });
        
        // è¾“å…¥æ¡†äº‹ä»¶
        const messageInput = document.getElementById('messageInput');
        
        // å›è½¦å‘é€
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        messageInput.addEventListener('input', () => {
            this.autoResizeTextarea();
        });
    }
    
    // åˆ‡æ¢AIæ¨¡å¼
    switchMode(mode) {
        if (this.isLoading) return;
        
        this.currentMode = mode;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.vm-mode-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
        
        // æ›´æ–°æ¨¡å¼æ˜¾ç¤º
        this.updateModeDisplay();
        
        // å¦‚æœå·²å¼€å§‹å¯¹è¯ï¼Œæ·»åŠ æ¨¡å¼åˆ‡æ¢æç¤º
        if (this.hasStartedChat) {
            this.addSystemMessage(`å·²åˆ‡æ¢åˆ° ${this.modes[mode].name} æ¨¡å¼`);
        }
        
        console.log(`ğŸ”„ æ¨¡å¼åˆ‡æ¢: ${this.modes[mode].name}`);
    }
    
    // æ›´æ–°æ¨¡å¼æ˜¾ç¤ºåŒºåŸŸ
    updateModeDisplay() {
        const modeInfo = this.modes[this.currentMode];
        document.getElementById('currentModeName').textContent = modeInfo.name;
        document.getElementById('currentModeIcon').className = modeInfo.icon;

        // æ›´æ–°æœç´¢æ¡†çš„placeholder
        this.updateInputPlaceholder();

        // æ›´æ–°çŒœä½ æƒ³é—®æ ‡ç­¾
        this.updateSuggestedQuestions();
    }

    // æ›´æ–°è¾“å…¥æ¡†placeholder
    updateInputPlaceholder() {
        const messageInput = document.getElementById('messageInput');
        const modeInfo = this.modes[this.currentMode];
        if (messageInput && modeInfo.placeholder) {
            messageInput.placeholder = modeInfo.placeholder;
        }
    }

    // éšæœºé€‰æ‹©é—®é¢˜ï¼ˆä»æ•°ç»„ä¸­éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„é—®é¢˜ï¼‰
    getRandomQuestions(questions, count = 4) {
        if (!questions || questions.length === 0) return [];
        if (questions.length <= count) return [...questions];

        // ä½¿ç”¨Fisher-Yatesæ´—ç‰Œç®—æ³•éšæœºé€‰æ‹©
        const shuffled = [...questions];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        return shuffled.slice(0, count);
    }

    // æ›´æ–°çŒœä½ æƒ³é—®æ ‡ç­¾
    updateSuggestedQuestions(useDynamicQuestions = false) {
        const suggestedContainer = document.getElementById('suggestedQuestions');
        if (!suggestedContainer) return;

        const modeInfo = this.modes[this.currentMode];

        // å†³å®šä½¿ç”¨å“ªä¸ªé—®é¢˜åˆ—è¡¨
        let questions = [];
        let titleText = 'çŒœä½ æƒ³é—®';

        if (useDynamicQuestions && this.dynamicQuestions.length > 0) {
            questions = this.dynamicQuestions;
            titleText = 'ç»§ç»­æ·±å…¥äº†è§£';
            console.log('ğŸ”„ ä½¿ç”¨åŠ¨æ€é—®é¢˜:', questions);
        } else {
            // ä»20ä¸ªé—®é¢˜ä¸­éšæœºé€‰æ‹©4ä¸ª
            const allQuestions = modeInfo.suggestedQuestions || [];
            questions = this.getRandomQuestions(allQuestions, 4);
            titleText = 'çŒœä½ æƒ³é—®';
            console.log('ğŸ”„ ä½¿ç”¨éšæœºé—®é¢˜ (ä»', allQuestions.length, 'ä¸ªä¸­é€‰æ‹©4ä¸ª):', questions);
        }

        // æ¸…ç©ºç°æœ‰å†…å®¹
        suggestedContainer.innerHTML = '';

        if (questions.length === 0) {
            suggestedContainer.style.display = 'none';
            return;
        }

        // æ˜¾ç¤ºçŒœä½ æƒ³é—®åŒºåŸŸ
        suggestedContainer.style.display = 'block';

        // æ·»åŠ æ ‡é¢˜
        const titleDiv = document.createElement('div');
        titleDiv.className = 'vm-suggested-title';
        titleDiv.innerHTML = `<i class="fas fa-lightbulb"></i> ${titleText}`;
        suggestedContainer.appendChild(titleDiv);

        // æ·»åŠ é—®é¢˜æ ‡ç­¾å®¹å™¨
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'vm-suggested-tags';

        questions.forEach((question, index) => {
            const tag = document.createElement('button');
            tag.className = 'vm-suggested-tag';
            tag.textContent = question;
            tag.onclick = () => this.selectSuggestedQuestion(question);

            // æ·»åŠ æ‚¬åœåŠ¨ç”»å»¶è¿Ÿ
            tag.style.animationDelay = `${index * 0.1}s`;

            tagsContainer.appendChild(tag);
        });

        suggestedContainer.appendChild(tagsContainer);
    }

    // é€‰æ‹©çŒœä½ æƒ³é—®çš„é—®é¢˜
    selectSuggestedQuestion(question) {
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.value = question;
            messageInput.focus();
            this.autoResizeTextarea();

            // æ·»åŠ è§†è§‰åé¦ˆ
            messageInput.style.background = 'rgba(212, 175, 55, 0.1)';
            setTimeout(() => {
                messageInput.style.background = '';
            }, 800);
        }
    }

    // è§£æAIå›ç­”ä¸­çš„åç»­é—®é¢˜
    parseFollowUpQuestions(aiResponse) {
        const startMarker = '===FOLLOW_UP_QUESTIONS===';
        const endMarker = '===END_FOLLOW_UP_QUESTIONS===';

        const startIndex = aiResponse.indexOf(startMarker);
        const endIndex = aiResponse.indexOf(endMarker);

        if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) {
            // æå–é—®é¢˜éƒ¨åˆ†
            const questionsText = aiResponse.substring(
                startIndex + startMarker.length,
                endIndex
            ).trim();

            // æå–çº¯å›ç­”å†…å®¹ï¼ˆç§»é™¤é—®é¢˜éƒ¨åˆ†ï¼‰
            const cleanResponse = aiResponse.substring(0, startIndex).trim();

            // è§£æé—®é¢˜åˆ—è¡¨
            const questions = questionsText
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .slice(0, 4); // ç¡®ä¿åªå–å‰4ä¸ª

            console.log('âœ… æˆåŠŸè§£æåç»­é—®é¢˜:', questions);
            console.log('ğŸ“ çº¯å›ç­”å†…å®¹é•¿åº¦:', cleanResponse.length);

            return {
                questions: questions,
                cleanResponse: cleanResponse,
                hasQuestions: questions.length > 0
            };
        }

        console.log('âš ï¸ æœªæ‰¾åˆ°åç»­é—®é¢˜æ ‡è®°ï¼Œä½¿ç”¨åŸå›ç­”');
        return {
            questions: [],
            cleanResponse: aiResponse,
            hasQuestions: false
        };
    }

    // æ›´æ–°åŠ¨æ€åç»­é—®é¢˜
    updateDynamicQuestions(questions) {
        if (questions && questions.length > 0) {
            this.dynamicQuestions = questions;

            // æ›´æ–°çŒœä½ æƒ³é—®æ˜¾ç¤º
            this.updateSuggestedQuestions(true); // trueè¡¨ç¤ºä½¿ç”¨åŠ¨æ€é—®é¢˜

            console.log('âœ… å·²æ›´æ–°åŠ¨æ€åç»­é—®é¢˜:', questions);
        }
    }
    
    // å‘é€æ¶ˆæ¯ä¸»å‡½æ•°
    async sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();

        if (!message || this.isLoading) return;

        // é¦–æ¬¡å‘é€æ¶ˆæ¯æ—¶ï¼Œæ˜¾ç¤ºå¯¹è¯åŒºåŸŸï¼Œéšè—æ¬¢è¿åŒºåŸŸ
        if (!this.hasStartedChat) {
            this.hasStartedChat = true;
            document.getElementById('welcomeArea').classList.add('hidden');
            document.getElementById('chatArea').classList.remove('hidden');
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        this.setLoadingState(true);

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
        this.addUserMessage(message);

        // æ¸…ç©ºè¾“å…¥æ¡†
        messageInput.value = '';
        this.autoResizeTextarea();

        // æ·»åŠ æ€è€ƒçŠ¶æ€æ¶ˆæ¯
        const thinkingMessage = this.addThinkingStatusMessage();
        const startTime = Date.now();

        try {
            // è°ƒç”¨API
            await this.callDeepSeekAPI(message);

        } catch (error) {
            console.error('âŒ APIè°ƒç”¨å¤±è´¥:', error);
            this.addErrorMessage(`æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥äº†ï¼š${error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'}`);
        } finally {
            // ç§»é™¤æ€è€ƒçŠ¶æ€æ¶ˆæ¯
            if (thinkingMessage) {
                thinkingMessage.remove();
            }

            // æ¢å¤æ­£å¸¸çŠ¶æ€
            this.setLoadingState(false);
            messageInput.focus();
        }
    }
    
    // è°ƒç”¨API - æ™®é€šéæµå¼è°ƒç”¨
    async callDeepSeekAPI(userMessage) {
        const modeInfo = this.modes[this.currentMode];

        // æ„å»ºæ¶ˆæ¯æ•°ç»„
        const messages = [
            {
                role: 'system',
                content: modeInfo.systemPrompt
            },
            // ä¿ç•™æœ€è¿‘6æ¡å¯¹è¯å†å²
            ...this.messages.slice(-6),
            {
                role: 'user',
                content: userMessage
            }
        ];

        // æ„å»ºè¯·æ±‚æ•°æ® - éæµå¼è°ƒç”¨
        const requestData = {
            model: this.config.model,
            messages: messages,
            stream: false,  // å…³é—­æµå¼è¾“å‡º
            temperature: this.config.temperature || 0.7,
            max_tokens: this.config.maxTokens || 4096,
            top_p: this.config.topP || 0.9
        };

        console.log('ğŸš€ å‘é€éæµå¼APIè¯·æ±‚:', {
            endpoint: `${this.config.baseURL}/bots/chat/completions`,
            model: requestData.model,
            messagesCount: messages.length,
            stream: requestData.stream,
            apiKeyPrefix: this.config.apiKey ? this.config.apiKey.substring(0, 10) + '...' : 'null'
        });

        // å‘é€APIè¯·æ±‚
        const response = await fetch(`${this.config.baseURL}/bots/chat/completions`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${this.config.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status, response.statusText);

        if (!response.ok) {
            let errorMessage = `HTTP ${response.status} ${response.statusText}`;
            try {
                const errorData = await response.json();
                console.error('âŒ APIé”™è¯¯è¯¦æƒ…:', errorData);
                errorMessage = errorData.error?.message || errorData.message || errorMessage;

                // ç‰¹æ®Šé”™è¯¯å¤„ç†
                if (response.status === 401) {
                    errorMessage = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·æ£€æŸ¥é…ç½®';
                } else if (response.status === 403) {
                    errorMessage = 'APIè®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                } else if (response.status === 404) {
                    errorMessage = 'æ¨¡å‹IDä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ¨¡å‹é…ç½®';
                } else if (response.status === 429) {
                    errorMessage = 'APIè°ƒç”¨é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åé‡è¯•';
                }
            } catch (e) {
                console.error('âŒ è§£æé”™è¯¯å“åº”å¤±è´¥:', e);
            }
            throw new Error(errorMessage);
        }

        // å¤„ç†æ™®é€šå“åº”
        const responseData = await response.json();
        console.log('ğŸ“Š APIå“åº”æ•°æ®:', responseData);

        // æå–AIå›å¤å†…å®¹
        const aiResponse = responseData.choices?.[0]?.message?.content;
        if (!aiResponse) {
            console.error('âŒ å“åº”æ•°æ®æ ¼å¼å¼‚å¸¸:', responseData);
            throw new Error('APIå“åº”æ ¼å¼å¼‚å¸¸ï¼Œæœªæ‰¾åˆ°æœ‰æ•ˆå†…å®¹');
        }

        // æ·»åŠ AIæ¶ˆæ¯åˆ°ç•Œé¢ï¼Œä½¿ç”¨æ‰“å­—æœºæ•ˆæœ
        this.addAIMessage(aiResponse);

        // ä¿å­˜å¯¹è¯å†å²
        this.messages.push(
            { role: 'user', content: userMessage },
            { role: 'assistant', content: aiResponse }
        );

        console.log('âœ… éæµå¼APIè°ƒç”¨æˆåŠŸ');
        return aiResponse;
    }

    // å¤„ç†æµå¼å“åº”
    async handleStreamResponse(response, userMessage) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';
        let thinkingContent = '';
        let isInThinking = false;

        // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        const modeInfo = this.modes[this.currentMode];

        messageDiv.className = 'vm-message ai';
        messageDiv.innerHTML = `
            <div class="vm-message-content">
                <div class="vm-message-header">
                    <div class="vm-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <span>æœ‰ç‰©AI Â· ${modeInfo.name}</span>
                </div>
                <div class="vm-thinking-section" id="thinking-section" style="display: none;">
                    <div class="vm-thinking-header">
                        <i class="fas fa-brain"></i>
                        <span>AIæ€ç»´è¿‡ç¨‹</span>
                        <button class="vm-thinking-toggle" onclick="this.parentElement.nextElementSibling.style.display = this.parentElement.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="vm-thinking-content" id="thinking-content"></div>
                </div>
                <div class="vm-message-text" id="ai-response"></div>
            </div>
        `;

        chatArea.appendChild(messageDiv);
        this.scrollToBottom();

        const thinkingSection = messageDiv.querySelector('#thinking-section');
        const thinkingContentEl = messageDiv.querySelector('#thinking-content');
        const responseEl = messageDiv.querySelector('#ai-response');

        try {
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') continue;

                        try {
                            const parsed = JSON.parse(data);
                            const choice = parsed.choices?.[0];
                            if (!choice) continue;

                            const delta = choice.delta;
                            if (!delta) continue;

                            // å¤„ç†æ€ç»´é“¾å†…å®¹
                            if (delta.thinking) {
                                if (!isInThinking) {
                                    isInThinking = true;
                                    thinkingSection.style.display = 'block';
                                }
                                thinkingContent += delta.thinking;
                                thinkingContentEl.textContent = thinkingContent;
                                this.scrollToBottom();
                            }

                            // å¤„ç†æ­£å¸¸å“åº”å†…å®¹
                            if (delta.content) {
                                isInThinking = false;
                                fullResponse += delta.content;
                                responseEl.innerHTML = this.formatMessage(fullResponse) + '<span class="vm-typing-cursor">|</span>';
                                this.scrollToBottom();
                            }

                        } catch (e) {
                            console.warn('è§£ææµå¼æ•°æ®é”™è¯¯:', e);
                        }
                    }
                }
            }
        } finally {
            reader.releaseLock();
        }

        // ç§»é™¤å…‰æ ‡
        responseEl.innerHTML = this.formatMessage(fullResponse);

        // ä¿å­˜å¯¹è¯å†å²
        this.messages.push(
            { role: 'user', content: userMessage },
            { role: 'assistant', content: fullResponse }
        );

        console.log('âœ… æµå¼APIè°ƒç”¨æˆåŠŸ');
        return fullResponse;
    }
    
    // è®¾ç½®åŠ è½½çŠ¶æ€
    setLoadingState(isLoading) {
        this.isLoading = isLoading;
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        
        if (isLoading) {
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="vm-thinking-dots"><div class="vm-thinking-dot"></div><div class="vm-thinking-dot"></div><div class="vm-thinking-dot"></div></div>';
            messageInput.disabled = true;
        } else {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            messageInput.disabled = false;
        }
    }
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addUserMessage(message) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'vm-message user';
        
        messageDiv.innerHTML = `
            <div class="vm-message-content">
                <div class="vm-message-header">
                    <div class="vm-message-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span>æ‚¨</span>
                </div>
                <div class="vm-message-text">${this.escapeHtml(message)}</div>
            </div>
        `;
        
        chatArea.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    // æ·»åŠ AIæ¶ˆæ¯ - å¸¦é€å­—è¾“å‡ºæ•ˆæœ
    addAIMessage(message) {
        // é¦–å…ˆè§£æAIå›ç­”ï¼Œåˆ†ç¦»åç»­é—®é¢˜
        const parsed = this.parseFollowUpQuestions(message);

        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        const modeInfo = this.modes[this.currentMode];
        const messageId = `ai-message-${Date.now()}`;

        messageDiv.className = 'vm-message ai';
        messageDiv.setAttribute('data-message-id', messageId);
        messageDiv.innerHTML = `
            <div class="vm-message-content">
                <div class="vm-message-header">
                    <div class="vm-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <span>æœ‰ç‰©AI Â· ${modeInfo.name}</span>
                </div>
                <div class="vm-message-text" id="${messageId}"></div>
            </div>
        `;

        chatArea.appendChild(messageDiv);
        this.scrollToBottom();

        // å¯åŠ¨é€å­—è¾“å‡ºï¼ˆåªæ˜¾ç¤ºçº¯å›ç­”å†…å®¹ï¼‰
        const messageTextEl = messageDiv.querySelector('.vm-message-text');
        this.typewriterEffect(messageTextEl, parsed.cleanResponse);

        // å¦‚æœæœ‰åç»­é—®é¢˜ï¼Œå­˜å‚¨èµ·æ¥ï¼Œç­‰æ‰“å­—æœºæ•ˆæœå®Œæˆåæ›´æ–°
        if (parsed.hasQuestions) {
            messageTextEl._followUpQuestions = parsed.questions;
        }

        // å­˜å‚¨æ¶ˆæ¯å¼•ç”¨ä»¥ä¾¿åç»­æ·»åŠ å¯¼å‡ºæŒ‰é’®
        messageTextEl._messageDiv = messageDiv;
    }

    // æ‰“å­—æœºæ•ˆæœ - å®Œå…¨ä¿®å¤åå°è¿è¡Œé—®é¢˜
    async typewriterEffect(element, text) {
        const formattedText = this.formatMessage(text);
        element.innerHTML = '<span class="vm-typing-cursor">|</span>';

        // è§£æHTMLå†…å®¹ï¼Œä½†é€å­—æ˜¾ç¤º
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = formattedText;

        let displayText = '';
        const plainText = tempDiv.textContent || tempDiv.innerText || '';

        // è®°å½•å¼€å§‹æ—¶é—´å’ŒçŠ¶æ€
        const startTime = Date.now();
        let charIndex = 0;
        let isCompleted = false;
        let animationId = null;

        // åˆ›å»ºæ‰“å­—æœºçŠ¶æ€å¯¹è±¡ï¼Œå­˜å‚¨åœ¨å…ƒç´ ä¸Š
        const typewriterState = {
            startTime,
            plainText,
            formattedText,
            displayText,
            charIndex,
            isCompleted,
            element,
            lastUpdateTime: Date.now()
        };

        // å°†çŠ¶æ€å­˜å‚¨åœ¨å…ƒç´ ä¸Šï¼Œä»¥ä¾¿é¡µé¢æ¿€æ´»æ—¶æ¢å¤
        element._typewriterState = typewriterState;

        const updateDisplay = () => {
            if (isCompleted || !element.isConnected) {
                // æ¸…ç†çŠ¶æ€
                if (element._typewriterState) {
                    delete element._typewriterState;
                }
                return;
            }

            const now = Date.now();
            const elapsedSinceStart = now - startTime;

            // æ ¹æ®é¡µé¢æ˜¯å¦åœ¨åå°è°ƒæ•´é€Ÿåº¦
            const speedMultiplier = document.hidden ? 10 : 1; // åå°æ—¶åŠ å¿«10å€
            const baseCharTime = 30; // æ¯ä¸ªå­—ç¬¦åŸºç¡€æ—¶é—´

            // è®¡ç®—åº”è¯¥æ˜¾ç¤ºåˆ°å“ªä¸ªå­—ç¬¦
            let targetCharIndex = Math.min(
                Math.floor(elapsedSinceStart / (baseCharTime / speedMultiplier)),
                plainText.length
            );

            // æ›´æ–°æ˜¾ç¤ºå†…å®¹åˆ°ç›®æ ‡ä½ç½®
            while (charIndex < targetCharIndex && charIndex < plainText.length) {
                displayText += plainText[charIndex];
                charIndex++;

                // åœ¨æ ‡ç‚¹å¤„ç¨ä½œåœé¡¿
                const char = plainText[charIndex - 1];
                if (char === '.' || char === '!' || char === '?') {
                    targetCharIndex = Math.min(targetCharIndex, charIndex + 3); // åœé¡¿3ä¸ªå­—ç¬¦æ—¶é—´
                    break;
                } else if (char === ',' || char === ';') {
                    targetCharIndex = Math.min(targetCharIndex, charIndex + 1); // åœé¡¿1ä¸ªå­—ç¬¦æ—¶é—´
                    break;
                }
            }

            // æ›´æ–°çŠ¶æ€
            typewriterState.charIndex = charIndex;
            typewriterState.displayText = displayText;
            typewriterState.lastUpdateTime = now;

            if (charIndex >= plainText.length) {
                // æ‰“å­—å®Œæˆ
                isCompleted = true;
                typewriterState.isCompleted = true;
                element.innerHTML = formattedText;
                this.scrollToBottom();

                // æ¸…ç†çŠ¶æ€
                if (element._typewriterState) {
                    delete element._typewriterState;
                }

                // æ‰“å­—æœºæ•ˆæœå®Œæˆåï¼Œæ£€æŸ¥å¹¶æ›´æ–°åç»­é—®é¢˜
                setTimeout(() => {
                    if (element._followUpQuestions) {
                        this.updateDynamicQuestions(element._followUpQuestions);
                        delete element._followUpQuestions; // æ¸…ç†ä¸´æ—¶æ•°æ®
                    }

                    // æ·»åŠ å¯¼å‡ºæŒ‰é’®
                    if (element._messageDiv) {
                        this.addExportButtons(element._messageDiv);
                        delete element._messageDiv; // æ¸…ç†ä¸´æ—¶æ•°æ®
                    }
                }, 1000);

                return;
            }

            // æ›´æ–°æ˜¾ç¤º
            const currentFormatted = this.formatMessage(displayText);
            element.innerHTML = currentFormatted + '<span class="vm-typing-cursor">|</span>';
            this.scrollToBottom();

            // ç»§ç»­ä¸‹ä¸€å¸§
            animationId = requestAnimationFrame(updateDisplay);
        };

        // é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
        const visibilityHandler = () => {
            if (!document.hidden && element._typewriterState && !isCompleted) {
                // é¡µé¢é‡æ–°æ¿€æ´»ä¸”æ‰“å­—æœºæœªå®Œæˆï¼Œæ¢å¤åŠ¨ç”»
                console.log('ğŸ”„ é¡µé¢é‡æ–°æ¿€æ´»ï¼Œæ¢å¤æ‰“å­—æœºæ•ˆæœ');
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                animationId = requestAnimationFrame(updateDisplay);
            }
        };

        document.addEventListener('visibilitychange', visibilityHandler);

        // å­˜å‚¨æ¸…ç†å‡½æ•°
        typewriterState.cleanup = () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            document.removeEventListener('visibilitychange', visibilityHandler);
        };

        // å¼€å§‹åŠ¨ç”»
        animationId = requestAnimationFrame(updateDisplay);

        // åœ¨å…ƒç´ è¢«ç§»é™¤æ—¶è‡ªåŠ¨æ¸…ç†
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.removedNodes.forEach((node) => {
                    if (node === element || node.contains?.(element)) {
                        typewriterState.cleanup();
                        observer.disconnect();
                    }
                });
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    }
    
    // æ·»åŠ æ€è€ƒçŠ¶æ€æ¶ˆæ¯ - ç²¾ç¾å¤šæ­¥éª¤å±•ç¤º
    addThinkingStatusMessage() {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        const modeInfo = this.modes[this.currentMode];

        messageDiv.className = 'vm-message ai';
        messageDiv.innerHTML = `
            <div class="vm-message-content">
                <div class="vm-message-header">
                    <div class="vm-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <span>æœ‰ç‰©AI Â· ${modeInfo.name}</span>
                </div>
                <div class="vm-thinking-process" style="
                    background: rgba(212, 175, 55, 0.03);
                    border: 1px solid rgba(212, 175, 55, 0.1);
                    border-radius: 12px;
                    padding: 16px;
                    margin-top: 8px;
                    font-size: 13px;
                    line-height: 1.5;
                ">
                    <div class="vm-thinking-header" style="
                        display: flex;
                        align-items: center;
                        margin-bottom: 12px;
                        font-size: 12px;
                        color: #D4AF37;
                        font-weight: 500;
                    ">
                        <i class="fas fa-brain" style="margin-right: 6px; font-size: 14px;"></i>
                        <span>AIæ·±åº¦åˆ†æä¸­</span>
                    </div>
                    <div class="vm-thinking-steps">
                        <div class="vm-step" id="step-0" style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 8px;
                            color: #888;
                            font-size: 12px;
                            opacity: 0;
                            transform: translateX(-10px);
                            transition: all 0.3s ease;
                        ">
                            <div class="vm-step-icon" style="
                                width: 16px;
                                height: 16px;
                                margin-right: 8px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <div class="vm-thinking-dot-mini" style="
                                    width: 4px;
                                    height: 4px;
                                    background: #D4AF37;
                                    border-radius: 50%;
                                    animation: vm-pulse 1.5s ease-in-out infinite;
                                "></div>
                            </div>
                            <span>æ­£åœ¨è§£æå¸‚åœºæ•°æ®ä¸è¶‹åŠ¿...</span>
                        </div>
                        <div class="vm-step" id="step-1" style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 8px;
                            color: #888;
                            font-size: 12px;
                            opacity: 0;
                            transform: translateX(-10px);
                            transition: all 0.3s ease;
                        ">
                            <div class="vm-step-icon" style="
                                width: 16px;
                                height: 16px;
                                margin-right: 8px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <div class="vm-thinking-dot-mini" style="
                                    width: 4px;
                                    height: 4px;
                                    background: #D4AF37;
                                    border-radius: 50%;
                                    animation: vm-pulse 1.5s ease-in-out infinite;
                                "></div>
                            </div>
                            <span>æ­£åœ¨æ¯”å¯¹ä¸ªè‚¡å†å²èµ°åŠ¿ä¸è¡Œä¸šåŸºå‡†...</span>
                        </div>
                        <div class="vm-step" id="step-2" style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 8px;
                            color: #888;
                            font-size: 12px;
                            opacity: 0;
                            transform: translateX(-10px);
                            transition: all 0.3s ease;
                        ">
                            <div class="vm-step-icon" style="
                                width: 16px;
                                height: 16px;
                                margin-right: 8px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <div class="vm-thinking-dot-mini" style="
                                    width: 4px;
                                    height: 4px;
                                    background: #D4AF37;
                                    border-radius: 50%;
                                    animation: vm-pulse 1.5s ease-in-out infinite;
                                "></div>
                            </div>
                            <span>æ­£åœ¨æ¨æ¼”å¤šç§å¯èƒ½çš„é£é™©è·¯å¾„...</span>
                        </div>
                        <div class="vm-step" id="step-3" style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 8px;
                            color: #888;
                            font-size: 12px;
                            opacity: 0;
                            transform: translateX(-10px);
                            transition: all 0.3s ease;
                        ">
                            <div class="vm-step-icon" style="
                                width: 16px;
                                height: 16px;
                                margin-right: 8px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <div class="vm-thinking-dot-mini" style="
                                    width: 4px;
                                    height: 4px;
                                    background: #D4AF37;
                                    border-radius: 50%;
                                    animation: vm-pulse 1.5s ease-in-out infinite;
                                "></div>
                            </div>
                            <span>æ­£åœ¨ç­›é€‰æ›´ç¨³å¥çš„æŠ•èµ„é€»è¾‘...</span>
                        </div>
                        <div class="vm-step" id="step-final" style="
                            display: flex;
                            align-items: center;
                            margin-top: 12px;
                            padding-top: 12px;
                            border-top: 1px solid rgba(212, 175, 55, 0.1);
                            color: #D4AF37;
                            font-size: 12px;
                            font-weight: 500;
                            opacity: 0;
                            transform: translateX(-10px);
                            transition: all 0.3s ease;
                        ">
                            <div class="vm-step-icon" style="
                                width: 16px;
                                height: 16px;
                                margin-right: 8px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <i class="fas fa-sparkles" style="font-size: 12px; color: #D4AF37;"></i>
                            </div>
                            <span>ç”Ÿæˆä¸“ä¸šåˆ†æç»“æœï¼Œæ·±åº¦æ€è€ƒä¸­ <span class="vm-timer">0</span>ç§’...</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        chatArea.appendChild(messageDiv);
        this.scrollToBottom();

        // æ·»åŠ CSSåŠ¨ç”»
        if (!document.getElementById('vm-pulse-animation')) {
            const style = document.createElement('style');
            style.id = 'vm-pulse-animation';
            style.textContent = `
                @keyframes vm-pulse {
                    0%, 100% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.5; transform: scale(1.2); }
                }
            `;
            document.head.appendChild(style);
        }

        // å¯åŠ¨æ­¥éª¤åŠ¨ç”»
        this.startThinkingStepsAnimation(messageDiv);

        // å¯åŠ¨è®¡æ—¶å™¨ - ä¿®å¤åå°è¿è¡Œé—®é¢˜
        const timerElement = messageDiv.querySelector('.vm-timer');
        const startTime = Date.now();

        const updateTimer = () => {
            if (!timerElement || !timerElement.isConnected) {
                return; // å…ƒç´ å·²è¢«ç§»é™¤ï¼Œåœæ­¢æ›´æ–°
            }
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            timerElement.textContent = elapsed;
        };

        // ä½¿ç”¨æ›´é¢‘ç¹çš„æ›´æ–°ç¡®ä¿åå°ä¹Ÿèƒ½å·¥ä½œ
        const timerInterval = setInterval(updateTimer, document.hidden ? 500 : 1000);

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œè°ƒæ•´æ›´æ–°é¢‘ç‡
        const visibilityHandler = () => {
            clearInterval(timerInterval);
            const newInterval = setInterval(updateTimer, document.hidden ? 500 : 1000);
            messageDiv._timerInterval = newInterval;
        };

        document.addEventListener('visibilitychange', visibilityHandler);

        // å°†interval IDå­˜å‚¨åœ¨å…ƒç´ ä¸Šï¼Œä»¥ä¾¿æ¸…ç†
        messageDiv._timerInterval = timerInterval;
        messageDiv._visibilityHandler = visibilityHandler;

        // è¦†ç›–removeæ–¹æ³•ï¼Œç¡®ä¿æ¸…ç†å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨
        const originalRemove = messageDiv.remove;
        messageDiv.remove = function() {
            if (this._timerInterval) {
                clearInterval(this._timerInterval);
            }
            if (this._visibilityHandler) {
                document.removeEventListener('visibilitychange', this._visibilityHandler);
            }
            originalRemove.call(this);
        };

        return messageDiv;
    }

    // å¯åŠ¨æ€è€ƒæ­¥éª¤åŠ¨ç”»
    startThinkingStepsAnimation(messageDiv) {
        const steps = ['step-0', 'step-1', 'step-2', 'step-3', 'step-final'];
        let currentStep = 0;

        const showNextStep = () => {
            if (currentStep > 0) {
                // å®Œæˆä¸Šä¸€æ­¥
                const prevStep = messageDiv.querySelector(`#${steps[currentStep - 1]}`);
                if (prevStep) {
                    const icon = prevStep.querySelector('.vm-step-icon');
                    if (icon && currentStep < steps.length) {
                        icon.innerHTML = '<i class="fas fa-check" style="font-size: 10px; color: #D4AF37;"></i>';
                    }
                }
            }

            if (currentStep < steps.length) {
                // æ˜¾ç¤ºå½“å‰æ­¥éª¤
                const currentStepEl = messageDiv.querySelector(`#${steps[currentStep]}`);
                if (currentStepEl) {
                    currentStepEl.style.opacity = '1';
                    currentStepEl.style.transform = 'translateX(0)';
                    this.scrollToBottom();
                }
                currentStep++;

                // è®¾ç½®ä¸‹ä¸€æ­¥çš„å»¶è¿Ÿæ—¶é—´ - åå°è¿è¡Œä¼˜åŒ–
                let delay = currentStep === steps.length ? 0 : (800 + Math.random() * 400); // 0.8-1.2ç§’éšæœºé—´éš”

                // é¡µé¢åœ¨åå°æ—¶åŠ å¿«åŠ¨ç”»é€Ÿåº¦
                if (document.hidden || document.visibilityState === 'hidden') {
                    delay = Math.min(delay, 300); // åå°æœ€å¤§å»¶è¿Ÿ300ms
                }

                if (currentStep < steps.length) {
                    setTimeout(showNextStep, delay);
                }
            }
        };

        // å¼€å§‹åŠ¨ç”»
        setTimeout(showNextStep, 200);
    }

    // æ·»åŠ AIæ€è€ƒçŠ¶æ€ - å¸¦æ€ç»´é“¾
    addThinkingMessage() {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        const modeInfo = this.modes[this.currentMode];

        messageDiv.className = 'vm-message ai';
        messageDiv.innerHTML = `
            <div class="vm-message-content">
                <div class="vm-message-header">
                    <div class="vm-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <span>æœ‰ç‰©AI Â· ${modeInfo.name}</span>
                </div>
                <div class="vm-thinking-chain">
                    <div class="vm-thinking-step" id="step-1">
                        <i class="fas fa-search"></i>
                        <span>æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...</span>
                        <div class="vm-thinking-dots">
                            <div class="vm-thinking-dot"></div>
                            <div class="vm-thinking-dot"></div>
                            <div class="vm-thinking-dot"></div>
                        </div>
                    </div>
                    <div class="vm-thinking-step hidden" id="step-2">
                        <i class="fas fa-cogs"></i>
                        <span>é€‰æ‹©æœ€ä½³åˆ†æè§’åº¦...</span>
                        <div class="vm-thinking-dots">
                            <div class="vm-thinking-dot"></div>
                            <div class="vm-thinking-dot"></div>
                            <div class="vm-thinking-dot"></div>
                        </div>
                    </div>
                    <div class="vm-thinking-step hidden" id="step-3">
                        <i class="fas fa-brain"></i>
                        <span>æ·±åº¦åˆ†æä¸­ï¼Œç”Ÿæˆä¸“ä¸šæ´å¯Ÿ...</span>
                        <div class="vm-thinking-dots">
                            <div class="vm-thinking-dot"></div>
                            <div class="vm-thinking-dot"></div>
                            <div class="vm-thinking-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        chatArea.appendChild(messageDiv);
        this.scrollToBottom();

        // å¯åŠ¨æ€ç»´é“¾åŠ¨ç”»
        this.startThinkingChain(messageDiv);

        return messageDiv;
    }

    // å¯åŠ¨æ€ç»´é“¾åŠ¨ç”»åºåˆ—
    startThinkingChain(messageDiv) {
        const steps = ['step-1', 'step-2', 'step-3'];
        let currentStep = 0;

        const nextStep = () => {
            if (currentStep > 0) {
                // å®Œæˆå½“å‰æ­¥éª¤
                const prevStep = messageDiv.querySelector(`#${steps[currentStep - 1]}`);
                if (prevStep) {
                    prevStep.classList.add('completed');
                    const dots = prevStep.querySelector('.vm-thinking-dots');
                    if (dots) {
                        dots.innerHTML = '<i class="fas fa-check" style="color: #D4AF37;"></i>';
                    }
                }
            }

            if (currentStep < steps.length) {
                // æ˜¾ç¤ºä¸‹ä¸€æ­¥
                const nextStepEl = messageDiv.querySelector(`#${steps[currentStep]}`);
                if (nextStepEl) {
                    nextStepEl.classList.remove('hidden');
                    this.scrollToBottom();
                }
                currentStep++;
                setTimeout(nextStep, 1500 + Math.random() * 1000); // 1.5-2.5ç§’éšæœºé—´éš”
            }
        };

        nextStep();
    }
    
    // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
    addSystemMessage(message) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        
        messageDiv.className = 'vm-message ai';
        messageDiv.innerHTML = `
            <div style="text-align: center; padding: 8px; margin: 8px 0;">
                <div style="display: inline-block; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); border-radius: 16px; padding: 6px 12px; font-size: 12px; color: #D4AF37;">
                    <i class="fas fa-info-circle"></i> ${message}
                </div>
            </div>
        `;
        
        chatArea.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    // æ·»åŠ é”™è¯¯æ¶ˆæ¯
    addErrorMessage(message) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        
        messageDiv.className = 'vm-message ai';
        messageDiv.innerHTML = `
            <div class="vm-message-content">
                <div class="vm-message-header">
                    <div class="vm-message-avatar" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <span style="color: #ef4444;">ç³»ç»Ÿæç¤º</span>
                </div>
                <div class="vm-message-text">${this.escapeHtml(message)}</div>
            </div>
        `;
        
        chatArea.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒç®€å•markdownï¼‰
    formatMessage(message) {
        return message
            .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #D4AF37;">$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px;">$1</code>')
            .replace(/#{1,6}\s+(.*?)$/gm, '<h4 style="color: #D4AF37; margin: 12px 0 8px 0; font-size: 16px; font-weight: 600;">$1</h4>')
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
    }
    
    // HTMLè½¬ä¹‰
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦å’Œæ»šåŠ¨æ¡
    autoResizeTextarea() {
        const textarea = document.getElementById('messageInput');
        const originalHeight = textarea.style.height;

        // é‡ç½®é«˜åº¦ä»¥è·å–å®é™…å†…å®¹é«˜åº¦
        textarea.style.height = 'auto';
        const scrollHeight = textarea.scrollHeight;
        const maxHeight = 140; // æœ€å¤§é«˜åº¦ï¼Œå¯¹åº”çº¦3è¡Œ
        const singleLineHeight = 56; // å•è¡Œé«˜åº¦

        // è®¾ç½®å®é™…é«˜åº¦
        const newHeight = Math.min(scrollHeight, maxHeight);
        textarea.style.height = newHeight + 'px';

        // åŠ¨æ€æ§åˆ¶æ»šåŠ¨æ¡æ˜¾ç¤ºï¼šåªæœ‰å½“å†…å®¹è¶…è¿‡çº¦2è¡Œæ—¶æ‰æ˜¾ç¤ºæ»šåŠ¨æ¡
        if (scrollHeight > singleLineHeight + 20) { // çº¦2è¡Œçš„é«˜åº¦
            textarea.classList.add('multiline');
        } else {
            textarea.classList.remove('multiline');
        }
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom() {
        const chatArea = document.getElementById('chatArea');
        setTimeout(() => {
            chatArea.scrollTop = chatArea.scrollHeight;
        }, 100);
    }

    // æ·»åŠ å¯¼å‡ºæŒ‰é’®åˆ°AIæ¶ˆæ¯
    addExportButtons(messageDiv) {
        const messageContent = messageDiv.querySelector('.vm-message-content');
        if (!messageContent) return;

        // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡å¯¼å‡ºæŒ‰é’®
        if (messageContent.querySelector('.vm-export-buttons')) return;

        const exportButtonsDiv = document.createElement('div');
        exportButtonsDiv.className = 'vm-export-buttons';
        exportButtonsDiv.innerHTML = `
            <button class="vm-export-btn" onclick="window.youwoAI.exportCurrentConversation('${messageDiv.getAttribute('data-message-id')}')">
                <i class="fas fa-download"></i>
                <span>å¯¼å‡ºå½“å‰å¯¹è¯</span>
            </button>
            <button class="vm-export-btn" onclick="window.youwoAI.exportAllConversations()">
                <i class="fas fa-images"></i>
                <span>å¯¼å‡ºå…¨éƒ¨å¯¹è¯</span>
            </button>
        `;

        messageContent.appendChild(exportButtonsDiv);
    }

    // å¯¼å‡ºå½“å‰å¯¹è¯ä¸ºå›¾ç‰‡
    async exportCurrentConversation(messageId) {
        try {
            console.log('ğŸ“¸ å¼€å§‹å¯¼å‡ºå½“å‰å¯¹è¯...');

            // æ‰¾åˆ°å½“å‰AIæ¶ˆæ¯åŠå…¶å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
            const aiMessageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!aiMessageDiv) {
                console.error('âŒ æœªæ‰¾åˆ°æŒ‡å®šçš„AIæ¶ˆæ¯');
                return;
            }

            // æ‰¾åˆ°å‰ä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯
            let userMessageDiv = aiMessageDiv.previousElementSibling;
            while (userMessageDiv && !userMessageDiv.classList.contains('user')) {
                userMessageDiv = userMessageDiv.previousElementSibling;
            }

            if (!userMessageDiv) {
                console.error('âŒ æœªæ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯');
                return;
            }

            // åˆ›å»ºå¯¼å‡ºå®¹å™¨
            const exportContainer = this.createExportContainer([userMessageDiv, aiMessageDiv]);

            // å¯¼å‡ºä¸ºå›¾ç‰‡
            await this.convertToImage(exportContainer, 'æœ‰ç‰©AI-å•æ¡å¯¹è¯');

            console.log('âœ… å½“å‰å¯¹è¯å¯¼å‡ºå®Œæˆ');
        } catch (error) {
            console.error('âŒ å¯¼å‡ºå½“å‰å¯¹è¯å¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    // å¯¼å‡ºå…¨éƒ¨å¯¹è¯ä¸ºå›¾ç‰‡
    async exportAllConversations() {
        try {
            console.log('ğŸ“¸ å¼€å§‹å¯¼å‡ºå…¨éƒ¨å¯¹è¯...');

            const chatArea = document.getElementById('chatArea');
            const allMessages = chatArea.querySelectorAll('.vm-message');

            if (allMessages.length === 0) {
                alert('æš‚æ— å¯¹è¯å†…å®¹å¯å¯¼å‡º');
                return;
            }

            // åˆ›å»ºå¯¼å‡ºå®¹å™¨
            const exportContainer = this.createExportContainer(Array.from(allMessages));

            // å¯¼å‡ºä¸ºå›¾ç‰‡
            await this.convertToImage(exportContainer, 'æœ‰ç‰©AI-å®Œæ•´å¯¹è¯');

            console.log('âœ… å…¨éƒ¨å¯¹è¯å¯¼å‡ºå®Œæˆ');
        } catch (error) {
            console.error('âŒ å¯¼å‡ºå…¨éƒ¨å¯¹è¯å¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    // åˆ›å»ºå¯¼å‡ºç”¨çš„å®¹å™¨
    createExportContainer(messageElements) {
        const container = document.createElement('div');
        container.style.cssText = `
            position: fixed;
            top: -10000px;
            left: -10000px;
            width: 800px;
            padding: 30px;
            background: #0a0a0a !important;
            color: #ffffff !important;
            font-family: 'Poppins', 'Noto Sans SC', sans-serif;
            box-sizing: border-box;
        `;

        // æ·»åŠ å…¨å±€æ ·å¼è¦†ç›–
        const globalStyle = document.createElement('style');
        globalStyle.textContent = `
            .export-container * {
                color: #ffffff !important;
            }
            .export-container .user-header {
                color: #D4AF37 !important;
            }
            .export-container .ai-header {
                color: #60a5fa !important;
            }
            .export-container strong {
                color: #D4AF37 !important;
                font-weight: 700 !important;
            }
            .export-container em {
                color: #f1f5f9 !important;
            }
            .export-container code {
                background-color: rgba(255, 255, 255, 0.15) !important;
                color: #fbbf24 !important;
                padding: 2px 6px !important;
                border-radius: 4px !important;
            }
            .export-container h1, .export-container h2, .export-container h3, .export-container h4, .export-container h5, .export-container h6 {
                color: #D4AF37 !important;
                font-weight: 700 !important;
            }
        `;
        document.head.appendChild(globalStyle);
        container.className = 'export-container';

        // æ·»åŠ å¤´éƒ¨
        const header = document.createElement('div');
        header.style.cssText = `
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 50%, #D4AF37 100%) !important;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        `;
        header.innerHTML = `
            <h1 style="
                font-size: 32px !important;
                font-weight: 700 !important;
                margin: 0 0 8px 0 !important;
                color: #0a0a0a !important;
                text-shadow: none !important;
            ">æœ‰ç‰© AI</h1>
            <p style="
                margin: 0 !important;
                color: rgba(10, 10, 10, 0.8) !important;
                font-size: 14px !important;
                font-weight: 500 !important;
            ">ä¸“ä¸šAIæŠ•ç ”åŠ©æ‰‹ Â· ${new Date().toLocaleDateString('zh-CN')}</p>
        `;
        container.appendChild(header);

        // æ·»åŠ æ¶ˆæ¯å†…å®¹
        const messagesContainer = document.createElement('div');
        messagesContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 16px;
        `;

        messageElements.forEach(messageDiv => {
            const clonedMessage = messageDiv.cloneNode(true);

            // ç§»é™¤å¯¼å‡ºæŒ‰é’®
            const exportButtons = clonedMessage.querySelector('.vm-export-buttons');
            if (exportButtons) {
                exportButtons.remove();
            }

            // ä¼˜åŒ–æ ·å¼ä»¥é€‚åº”å¯¼å‡º
            const messageContent = clonedMessage.querySelector('.vm-message-content');
            if (messageContent) {
                messageContent.style.cssText += `
                    background: rgba(255, 255, 255, 0.08) !important;
                    border: 1px solid rgba(255, 255, 255, 0.2) !important;
                    border-radius: 12px !important;
                    padding: 16px !important;
                    backdrop-filter: none !important;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
                    margin-bottom: 0 !important;
                `;
            }

            // å¤„ç†ç”¨æˆ·æ¶ˆæ¯æ ·å¼
            if (clonedMessage.classList.contains('user')) {
                const content = clonedMessage.querySelector('.vm-message-content');
                if (content) {
                    content.style.cssText += `
                        background: rgba(212, 175, 55, 0.25) !important;
                        border-color: rgba(212, 175, 55, 0.4) !important;
                    `;
                }

                // ç”¨æˆ·æ¶ˆæ¯å¤´éƒ¨æ·»åŠ ç‰¹æ®Šç±»
                const userHeader = clonedMessage.querySelector('.vm-message-header span');
                if (userHeader) {
                    userHeader.className = 'user-header';
                }
            }

            // å¤„ç†AIæ¶ˆæ¯æ ·å¼
            if (clonedMessage.classList.contains('ai')) {
                const content = clonedMessage.querySelector('.vm-message-content');
                if (content) {
                    content.style.cssText += `
                        background: rgba(37, 99, 235, 0.2) !important;
                        border-color: rgba(37, 99, 235, 0.35) !important;
                    `;
                }

                // AIæ¶ˆæ¯å¤´éƒ¨æ·»åŠ ç‰¹æ®Šç±»
                const aiHeader = clonedMessage.querySelector('.vm-message-header span');
                if (aiHeader) {
                    aiHeader.className = 'ai-header';
                }
            }

            // å¼ºåˆ¶è®¾ç½®æ¶ˆæ¯æ–‡æœ¬é¢œè‰² - ç›´æ¥ä¿®æ”¹innerHTML
            const messageText = clonedMessage.querySelector('.vm-message-text');
            if (messageText) {
                // è·å–åŸå§‹HTMLå†…å®¹
                let originalHTML = messageText.innerHTML;

                // ä½¿ç”¨ä¸€ä¸ªåŒ…è£…divæ¥ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½æ˜¯ç™½è‰²
                const wrappedHTML = `<div style="color: #ffffff !important; line-height: 1.6 !important; font-size: 14px !important;">${originalHTML}</div>`;
                messageText.innerHTML = wrappedHTML;

                // å¼ºåˆ¶è®¾ç½®ç›´æ¥æ ·å¼
                messageText.style.cssText = `
                    color: #ffffff !important;
                    line-height: 1.6 !important;
                    font-size: 14px !important;
                `;
            }

            messagesContainer.appendChild(clonedMessage);
        });

        container.appendChild(messagesContainer);

        // æ·»åŠ åº•éƒ¨æ°´å°
        const footer = document.createElement('div');
        footer.style.cssText = `
            text-align: center !important;
            margin-top: 30px !important;
            padding-top: 20px !important;
            border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #ffffff !important;
            font-size: 12px !important;
            opacity: 0.8 !important;
        `;
        footer.innerHTML = `ç”Ÿæˆäº voidmatter.cn Â· è™šç©ºæœ‰ç‰©ç§‘æŠ€`;
        container.appendChild(footer);

        document.body.appendChild(container);
        return container;
    }

    // å°†å®¹å™¨è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
    async convertToImage(container, filename) {
        try {
            // åŠ¨æ€å¯¼å…¥html2canvasåº“
            if (!window.html2canvas) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                document.head.appendChild(script);

                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                });
            }

            // ä½¿ç”¨html2canvasç”Ÿæˆå›¾ç‰‡
            const canvas = await html2canvas(container, {
                backgroundColor: '#0a0a0a',
                scale: 2, // æé«˜å›¾ç‰‡è´¨é‡
                useCORS: true,
                allowTaint: true,
                height: container.scrollHeight,
                width: container.scrollWidth,
                logging: false, // å…³é—­æ—¥å¿—ä»¥é¿å…å¹²æ‰°
                ignoreElements: (element) => {
                    // å¿½ç•¥å¯èƒ½å¹²æ‰°çš„å…ƒç´ 
                    return element.tagName === 'SCRIPT' || element.tagName === 'STYLE';
                }
            });

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.download = `${filename}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);

            // è§¦å‘ä¸‹è½½
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // æ¸…ç†ä¸´æ—¶å®¹å™¨å’Œæ ·å¼
            document.body.removeChild(container);

            // ç§»é™¤æ·»åŠ çš„å…¨å±€æ ·å¼
            const globalStyles = document.querySelectorAll('style');
            globalStyles.forEach(style => {
                if (style.textContent && style.textContent.includes('.export-container')) {
                    document.head.removeChild(style);
                }
            });

        } catch (error) {
            console.error('âŒ å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', error);

            // ç¡®ä¿æ¸…ç†å·¥ä½œå®Œæˆ
            if (document.body.contains(container)) {
                document.body.removeChild(container);
            }

            // ç§»é™¤æ ·å¼
            const globalStyles = document.querySelectorAll('style');
            globalStyles.forEach(style => {
                if (style.textContent && style.textContent.includes('.export-container')) {
                    document.head.removeChild(style);
                }
            });

            throw error;
        }
    }

    // æµ‹è¯•åŠ¨æ€é—®é¢˜ç”ŸæˆåŠŸèƒ½
    testDynamicQuestions() {
        console.log('ğŸ§ª å¼€å§‹æµ‹è¯•åŠ¨æ€é—®é¢˜ç”ŸæˆåŠŸèƒ½...');

        // æ¨¡æ‹ŸåŒ…å«ç»“æ„åŒ–é—®é¢˜çš„AIå›å¤
        const mockAIResponse = `åŸºäºå½“å‰å¸‚åœºç¯å¢ƒåˆ†æï¼Œæ–°èƒ½æºæ±½è½¦è¡Œä¸šåœ¨2025å¹´å°†ç»§ç»­ä¿æŒå¿«é€Ÿå¢é•¿æ€åŠ¿ã€‚ä¸»è¦é©±åŠ¨å› ç´ åŒ…æ‹¬ï¼š

1. **æ”¿ç­–æ”¯æŒæŒç»­**ï¼šå„å›½æ”¿åºœç»§ç»­æ¨å‡ºä¿ƒè¿›æ–°èƒ½æºæ±½è½¦å‘å±•çš„æ”¿ç­–
2. **æŠ€æœ¯çªç ´**ï¼šç”µæ± æŠ€æœ¯å’Œæ™ºèƒ½é©¾é©¶æŠ€æœ¯ä¸æ–­è¿›æ­¥
3. **æ¶ˆè´¹è€…æ¥å—åº¦æå‡**ï¼šå¸‚åœºè®¤çŸ¥åº¦å’Œè´­ä¹°æ„æ„¿æ˜¾è‘—æé«˜

é¢„è®¡2025å¹´å…¨çƒæ–°èƒ½æºæ±½è½¦é”€é‡å°†è¾¾åˆ°1800ä¸‡è¾†ï¼ŒåŒæ¯”å¢é•¿35%ã€‚

===FOLLOW_UP_QUESTIONS===
æ–°èƒ½æºæ±½è½¦äº§ä¸šé“¾ä¸Šå“ªäº›ç¯èŠ‚æœ€å…·æŠ•èµ„ä»·å€¼ï¼Ÿ
ç‰¹æ–¯æ‹‰å’Œæ¯”äºšè¿ªçš„ç«äº‰æ ¼å±€ä¼šå¦‚ä½•æ¼”å˜ï¼Ÿ
ç”µæ± æŠ€æœ¯çªç ´å¯¹æ•´ä¸ªè¡Œä¸šä¼°å€¼çš„å½±å“æœ‰å¤šå¤§ï¼Ÿ
æ–°èƒ½æºæ±½è½¦è¡¥è´´æ”¿ç­–é€€å¡å¯¹é”€é‡æœ‰ä½•å½±å“ï¼Ÿ
===END_FOLLOW_UP_QUESTIONS===`;

        // è°ƒç”¨è§£æå‡½æ•°
        const parsed = this.parseFollowUpQuestions(mockAIResponse);

        console.log('ğŸ“ è§£æç»“æœ:', parsed);
        console.log('â“ é—®é¢˜æ•°é‡:', parsed.questions.length);
        console.log('âœ… è§£ææˆåŠŸ:', parsed.hasQuestions);

        if (parsed.hasQuestions) {
            // æµ‹è¯•é—®é¢˜æ›´æ–°
            console.log('ğŸ”„ æ›´æ–°åŠ¨æ€é—®é¢˜...');
            this.updateDynamicQuestions(parsed.questions);

            console.log('âœ… æµ‹è¯•å®Œæˆ - åŠ¨æ€é—®é¢˜ç”ŸæˆåŠŸèƒ½æ­£å¸¸');
            return true;
        } else {
            console.log('âŒ æµ‹è¯•å¤±è´¥ - é—®é¢˜è§£æå¤±è´¥');
            return false;
        }
    }

    // APIè¿æ¥æµ‹è¯•å‡½æ•°
    async testAPIConnection() {
        try {
            console.log('ğŸ” æµ‹è¯•APIè¿æ¥...');
            console.log('ğŸ“‹ å½“å‰é…ç½®:', {
                baseURL: this.config.baseURL,
                model: this.config.model,
                apiKey: this.config.apiKey ? this.config.apiKey.substring(0, 10) + '...' : 'null'
            });

            // ä½¿ç”¨éæµå¼æ ¼å¼è¿›è¡Œæµ‹è¯•
            const requestData = {
                model: this.config.model,
                messages: [
                    {
                        role: "system",
                        content: "You are a helpful assistant."
                    },
                    {
                        role: "user",
                        content: "Hello!"
                    }
                ],
                stream: false,  // éæµå¼è°ƒç”¨
                temperature: 0.7,
                max_tokens: 100,
                top_p: 0.9
            };

            console.log('ğŸ“¤ å‘é€æµ‹è¯•è¯·æ±‚:', JSON.stringify(requestData, null, 2));

            const response = await fetch(`${this.config.baseURL}/bots/chat/completions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.config.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            console.log('ğŸ“¡ å“åº”çŠ¶æ€:', response.status, response.statusText);
            console.log('ğŸ“‹ å“åº”å¤´:', Object.fromEntries(response.headers.entries()));

            if (response.ok) {
                console.log('âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸ');

                try {
                    const responseData = await response.json();
                    console.log('ğŸ“Š å®Œæ•´å“åº”æ•°æ®:', responseData);

                    // æ£€æŸ¥å“åº”æ ¼å¼
                    if (responseData.choices && responseData.choices.length > 0) {
                        const aiContent = responseData.choices[0].message?.content;
                        if (aiContent) {
                            console.log('âœ… æˆåŠŸæ¥æ”¶åˆ°AIå“åº”å†…å®¹:', `"${aiContent}"`);
                            return true;
                        } else {
                            console.log('âš ï¸ è­¦å‘Š: å“åº”ä¸­æ²¡æœ‰contentå­—æ®µ');
                            return false;
                        }
                    } else {
                        console.log('âš ï¸ è­¦å‘Š: å“åº”ä¸­æ²¡æœ‰choicesæ•°ç»„æˆ–ä¸ºç©º');
                        console.log('å¯èƒ½çš„åŸå› :');
                        console.log('1. æ¨¡å‹é…ç½®é—®é¢˜');
                        console.log('2. APIå‚æ•°è®¾ç½®é—®é¢˜');
                        return false;
                    }

                } catch (parseError) {
                    console.error('âŒ è§£æå“åº”æ•°æ®å¤±è´¥:', parseError);
                    return false;
                }

            } else {
                let errorData;
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = { message: 'æ— æ³•è§£æé”™è¯¯å“åº”' };
                }
                console.error('âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥:');
                console.error('çŠ¶æ€ç :', response.status);
                console.error('çŠ¶æ€æ–‡æœ¬:', response.statusText);
                console.error('é”™è¯¯è¯¦æƒ…:', errorData);

                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (document.getElementById('welcomeArea')) {
                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = `
                        color: #ef4444;
                        background: rgba(239, 68, 68, 0.1);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        border-radius: 8px;
                        padding: 12px;
                        margin-top: 16px;
                        font-size: 13px;
                    `;
                    errorMsg.innerHTML = `
                        <strong>API è¿æ¥å¤±è´¥</strong><br>
                        çŠ¶æ€ç : ${response.status}<br>
                        é”™è¯¯: ${errorData.message || errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}<br>
                        <small>è¯·æ£€æŸ¥APIå¯†é’¥å’Œæ¨¡å‹IDæ˜¯å¦æ­£ç¡®</small>
                    `;
                    document.getElementById('welcomeArea').appendChild(errorMsg);
                }

                return false;
            }
        } catch (error) {
            console.error('âŒ APIè¿æ¥æµ‹è¯•é”™è¯¯:', error);
            console.error('é”™è¯¯ç±»å‹:', error.name);
            console.error('é”™è¯¯æ¶ˆæ¯:', error.message);

            // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºç½‘ç»œé”™è¯¯
            if (document.getElementById('welcomeArea')) {
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = `
                    color: #ef4444;
                    background: rgba(239, 68, 68, 0.1);
                    border: 1px solid rgba(239, 68, 68, 0.3);
                    border-radius: 8px;
                    padding: 12px;
                    margin-top: 16px;
                    font-size: 13px;
                `;
                errorMsg.innerHTML = `
                    <strong>ç½‘ç»œè¿æ¥é”™è¯¯</strong><br>
                    ${error.message || 'æ— æ³•è¿æ¥åˆ° API æœåŠ¡å™¨'}<br>
                    <small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•åœ¨æœ¬åœ°æœåŠ¡å™¨ç¯å¢ƒä¸‹è¿è¡Œ</small>
                `;
                document.getElementById('welcomeArea').appendChild(errorMsg);
            }

            return false;
        }
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–æœ‰ç‰©AI
    window.youwoAI = new YouwoAI();

    console.log('ğŸš€ æœ‰ç‰©AIç²¾ç®€ç‰ˆå·²å¯åŠ¨');
    console.log('ğŸ“± é‡‡ç”¨å¤¸å…‹AIé£æ ¼çš„ç®€æ´ç•Œé¢');
    console.log('ğŸ§  æ”¯æŒæ¨¡å¼:', Object.keys(window.youwoAI.modes));

    // è‡ªåŠ¨æµ‹è¯•APIè¿æ¥
    window.youwoAI.testAPIConnection();
});